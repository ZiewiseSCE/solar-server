<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì—…ê·¸ë ˆì´ë“œ -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        #login-overlay.hidden-overlay { opacity: 0; pointer-events: none; }
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        #sidebar-toggle-btn { left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001; }
        #sidebar-toggle-btn.collapsed { left: 0; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .login-input { background: rgba(30, 41, 59, 0.5); border: 1px solid #475569; color: white; transition: all 0.3s; }
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:hover { background: #475569; transform: translateY(-1px); }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        .plant-marker { background: #fbbf24; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .substation-marker { background: #ef4444; border: 2px solid white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
    </form>

    <div id="login-overlay">
        <!-- ë¡œê·¸ì¸ í™”ë©´ (ê¸°ì¡´ê³¼ ë™ì¼) -->
        <div class="bg-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-700 w-[400px] text-center relative overflow-hidden" id="login-box">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500"></div>
            <div class="mb-6 relative">
                <div class="mx-auto w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-slate-700 shadow-lg"><i class="ph ph-solar-panel text-3xl text-cyan-400"></i></div>
                <h1 class="text-2xl font-bold text-white tracking-tight">SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
                <p class="text-slate-400 text-sm mt-2">íƒœì–‘ê´‘ ë°œì „ ë¶„ì„ í´ë¼ìš°ë“œ (Enterprise)</p>
                <button onclick="exitAdminMode()" id="exit-admin-btn" aria-label="ë‹«ê¸°" class="hidden absolute top-0 right-0 text-slate-500 hover:text-white"><i class="ph ph-x"></i></button>
            </div>
            <!-- ì‚¬ìš©ì ë¡œê·¸ì¸ -->
            <div id="step-user-login" class="space-y-4">
                <div class="space-y-3 text-left">
                    <div><label for="userId" class="text-xs font-bold text-slate-400 ml-1">ì•„ì´ë””</label><input type="text" id="userId" placeholder="User ID" class="login-input w-full rounded px-4 py-3 text-sm mt-1"></div>
                    <div><label for="userPw" class="text-xs font-bold text-slate-400 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="userPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="login-input w-full rounded px-4 py-3 text-sm mt-1" onkeypress="if(event.key==='Enter') attemptLogin()"></div>
                </div>
                <button onclick="attemptLogin()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg transition mt-2">ì ‘ì†í•˜ê¸°</button>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-700/50"><button onclick="showAdminLogin()" class="text-[10px] text-slate-500 hover:text-cyan-400 transition font-bold flex items-center gap-1"><i class="ph ph-lock-key"></i> ê´€ë¦¬ì ë¡œê·¸ì¸</button></div>
            </div>
            <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
            <div id="step-admin-login" class="hidden space-y-4">
                <div class="text-left"><label for="adminPw" class="text-xs font-bold text-red-400 ml-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="adminPw" class="login-input w-full rounded px-4 py-3 text-sm font-mono mt-1" placeholder="Admin Password" onkeypress="if(event.key==='Enter') verifyAdmin()"></div>
                <button onclick="verifyAdmin()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition">ê´€ë¦¬ì ì ‘ì†</button>
                <button onclick="exitAdminMode()" class="text-xs text-slate-400 hover:text-white">ëŒì•„ê°€ê¸°</button>
            </div>
            <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
            <div id="step-admin-dashboard" class="hidden space-y-4">
                <div class="bg-slate-800/50 rounded-lg p-3 text-left border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">ì‹ ê·œ ìœ ì € ë“±ë¡</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label for="newUserId" class="sr-only">ID</label><input type="text" id="newUserId" placeholder="ì•„ì´ë””" class="login-input rounded px-2 py-1.5 text-xs w-full"></div>
                        <div><label for="newUserPw" class="sr-only">PW</label><input type="text" id="newUserPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="login-input rounded px-2 py-1.5 text-xs w-full"></div>
                    </div>
                    <button onclick="addUser()" class="w-full bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-xs font-bold">ìœ ì € ì¶”ê°€</button>
                </div>
                <div class="text-left"><label class="text-[10px] font-bold text-slate-400 block mb-1 flex justify-between"><span>ë“±ë¡ëœ ìœ ì € ëª©ë¡</span><span id="user-count" class="text-cyan-500">0ëª…</span></label><div class="bg-slate-800 rounded border border-slate-700 h-32 overflow-y-auto p-2 space-y-1" id="user-list-container"></div></div>
                <div class="flex gap-2 pt-2"><button onclick="exitAdminMode()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs">ë‚˜ê°€ê¸°</button></div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
            <div class="flex justify-between items-center text-[10px] text-slate-400 mt-2 border-t border-slate-700 pt-2"><span id="currentUserDisplay">Not Logged In</span><button onclick="logout('Manual')" class="text-red-400 hover:text-red-300 underline">ë¡œê·¸ì•„ì›ƒ</button></div>
            <div class="grid grid-cols-3 gap-1 mt-3 text-center">
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400">OK</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">DB Sync</div><div id="cnt-public" class="font-mono font-bold text-yellow-400">OK</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400">OK</div></div>
            </div>
        </div>
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button onclick="switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg text-purple-600"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="flex-1 overflow-y-auto bg-slate-50">
            <div class="p-4 pb-0">
                <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4" open>
                    <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg"><span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i></summary>
                    <div class="p-3 space-y-3 border-t border-gray-200">
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100 text-xs">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label for="modWidth" class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div><div><label for="modHeight" class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div></div>
                             <!-- [í™•ì¸] ì„¤ì¹˜ ìµœëŒ€ë†’ì´ ë°˜ì˜ -->
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label for="installHeight" class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ìµœëŒ€ë†’ì´(m)</label><input type="number" id="installHeight" value="0.5" step="0.1" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div><div><label for="installAngle" class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2"><div><label for="modPower" class="block mb-0.5 text-[10px] text-slate-500">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div><div><label for="rowSpacing" class="block mb-0.5 text-[10px] text-slate-500">ì´ê²©(m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div></div>
                        </div>
                        <div class="bg-green-50 p-2 rounded border border-green-200 text-xs">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label for="modPrice" class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700 bg-white" onchange="reCalculate()"></div><div><label for="costPerKw" class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œ)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label for="smp" class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div><div><label for="rec" class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2"><div><label for="pfLoanRatio" class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center text-blue-600 font-bold bg-white" onchange="reCalculate()"></div><div><label for="pfInterestRate" class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold bg-white" onchange="reCalculate()"></div></div>
                        </div>
                    </div>
                </details>
                <div class="flex gap-2 text-xs mb-4">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="toggleTarget()" aria-label="í† ì§€"><div class="text-center py-2 border rounded bg-white peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-tree"></i> í† ì§€ (Land)</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="toggleTarget()" checked aria-label="ì§€ë¶•"><div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-factory"></i> ì§€ë¶• (Roof)</div></label>
                </div>
            </div>

            <div class="px-4 pb-4">
                <!-- 1. ìŠ¤ìº” íŒ¨ë„ -->
                <div id="panel-scan" class="space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <label for="regionSelect" class="text-xs font-bold text-gray-700 mb-2 block">ğŸ“ ì§€ì—­ ì„ íƒ</label>
                        <select id="regionSelect" onchange="setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none">
                            <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì¶©ì²­ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="cheonan_ind">ì²œì•ˆ ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="osan_ind">ì˜¤ì°½ ê³¼í•™ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daejeon_ind">ëŒ€ì „ ëŒ€ë•í…Œí¬ë…¸ë°¸ë¦¬</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì˜ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                <option value="daegu_ind">ëŒ€êµ¬ ì„±ì„œê³µë‹¨</option>
                                <option value="pohang_ind">í¬í•­ ì² ê°•ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸ­ í˜¸ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gwangju_ind">ê´‘ì£¼ í•˜ë‚¨/ì²¨ë‹¨ ì‚°ë‹¨</option>
                                <option value="yeosu_ind">ì—¬ìˆ˜ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daebul_ind">ì˜ì•” ëŒ€ë¶ˆì‚°ë‹¨</option>
                                <option value="gunsan_ind">êµ°ì‚° êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                <option value="gyeonggi">ê²½ê¸°ë„</option>
                                <option value="incheon">ì¸ì²œê´‘ì—­ì‹œ</option>
                                <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                <option value="jeonbuk">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
                                <option value="gyeongbuk">ê²½ìƒë¶ë„</option>
                                <option value="chungnam">ì¶©ì²­ë‚¨ë„</option>
                                <option value="chungbuk">ì¶©ì²­ë¶ë„</option>
                                <option value="gangwon">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                        <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                            <label for="scanDelay" class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                            <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="updateEstimatedTime()"><option value="1000">1ì´ˆ</option><option value="3000">3ì´ˆ</option><option value="5000">5ì´ˆ</option></select>
                        </div>
                        <div class="flex justify-between items-end"><div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div><div id="progressCount" class="text-[10px] text-gray-500 font-mono">0 / 20</div></div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden"><div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                        <!-- [ì¶”ê°€] ìŠ¤ìº”ëœ êµ¬ì—­ ìˆ˜ í‘œì‹œ -->
                        <div class="flex justify-between items-end mt-1 px-1"><div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div></div>
                        <div class="grid grid-cols-2 gap-2 pt-1"><button onclick="startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button><button onclick="clearResults()" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ì´ˆê¸°í™”</button></div>
                    </div>
                </div>

                <!-- 2. ì •ë°€ ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-analysis" class="hidden space-y-4">
                    <div class="bg-slate-800 p-2 rounded-lg border border-indigo-500/50 shadow-lg mb-2">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ì¡°ì • (D-Pad)</span><button onclick="resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                        <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                             <div class="grid grid-cols-3 gap-2">
                                <div></div><button class="d-pad-btn" onclick="applyCalibration(0, 0.5)">â–²</button><div></div>
                                <button class="d-pad-btn" onclick="applyCalibration(-0.5, 0)">â—€</button>
                                <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                                <button class="d-pad-btn" onclick="applyCalibration(0.5, 0)">â–¶</button>
                                <div></div><button class="d-pad-btn" onclick="applyCalibration(0, -0.5)">â–¼</button><div></div>
                             </div>
                             <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                                <button class="d-pad-btn flex-1 text-[10px]" onclick="applyCalibration(0, 0, -5)">â†º íšŒì „</button>
                                <button class="d-pad-btn flex-1 text-[10px]" onclick="applyCalibration(0, 0, 5)">â†» íšŒì „</button>
                            </div>
                        </div>
                    </div>

                    <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                        <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right">-</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰:</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">-</span></div>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600">
                            <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                            <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                        </div>
                        <div class="bg-indigo-900/40 p-2 rounded space-y-1 border border-indigo-500/30 text-[10px]">
                            <div class="flex justify-between text-indigo-300 font-bold border-b border-indigo-500/30 pb-1 mb-1"><span>ğŸ¦ PF ê¸ˆìœµêµ¬ì¡° (<span id="pfRatioDisplay">90</span>%)</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ëŒ€ì¶œê¸ˆ:</span><span id="resLoanAmount" class="text-white">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìê¸°ìë³¸:</span><span id="resEquityAmount" class="text-white">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ì—° ì´ì:</span><span id="resInterest" class="text-red-300">0 ì›</span></div>
                            <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                        </div>
                        
                        <div class="flex gap-2 mt-2">
                             <button onclick="saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition flex items-center justify-center gap-1"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                             <button onclick="openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition flex items-center justify-center gap-1"><i class="ph ph-file-text"></i> ìƒì„¸ ë¦¬í¬íŠ¸</button>
                        </div>
                    </div>
                </div>

                <!-- 3. ê¸°ë¡ íŒ¨ë„ -->
                <div id="panel-history" class="hidden space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                            <button onclick="clearHistory()" class="text-[10px] text-red-500 hover:underline">ì „ì²´ ì‚­ì œ</button>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto">
                            <p class="text-xs text-slate-400 text-center py-4">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <!-- 4. ì¢…í•© ë¦¬í¬íŠ¸ íŒ¨ë„ -->
                <div id="panel-legal" class="hidden space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                        <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> AI ì¸í—ˆê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h3>
                        
                        <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                            <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>
                            ê±´ë¬¼ì„ ì„ íƒí•˜ë©´ SolarAIê°€<br>ì¢…í•© ì…ì§€ ë¶„ì„(ìš©ë„, ìƒíƒœ, í•œì „ ë“±)ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                        </div>

                        <div id="legalLoading" class="hidden text-center py-10">
                            <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                            <p class="text-xs text-purple-300 animate-pulse">ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ë° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>

                        <div id="legalContent" class="hidden space-y-4 mt-2">
                             <div class="bg-purple-900/30 p-2 rounded border border-purple-500/30 text-xs text-purple-200 mb-2">
                                ğŸ¤– <span class="font-bold">SolarAI Analysis Result</span>
                            </div>
                            <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                            <div class="text-[10px] text-slate-500 text-right mt-2">* ë°ì´í„° ì¶œì²˜: V-World, ê³µê³µë°ì´í„°í¬í„¸, Open-Meteo</div>
                        </div>
                    </div>
                </div>
                
                <div id="loading" class="hidden flex flex-col items-center justify-center py-4"><div class="spinner mb-2"></div><p class="text-xs text-slate-500">ë°ì´í„° ì²˜ë¦¬ì¤‘...</p></div>
            </div>
        </div>
        
        <div class="h-24 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow"><div class="text-green-500">> System Ready.</div></div>
    </div>
    
    <div id="sidebar-toggle-btn" onclick="toggleSidebar()" class="absolute top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600"><i class="ph ph-caret-left font-bold transition-transform"></i></div>
    <div class="absolute top-5 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col items-center gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <label for="addrInput" class="sr-only">ì£¼ì†Œ ê²€ìƒ‰</label>
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" 
                   class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium"
                   onkeypress="if(event.key==='Enter') searchAddress()">
            <button onclick="searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md" aria-label="ê²€ìƒ‰"><i class="ph ph-magnifying-glass font-bold"></i></button>
        </div>
    </div>
    
    <div class="absolute top-5 right-5 z-[1000] bg-white p-2 rounded-lg shadow-lg border border-gray-200 text-xs w-44">
        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 hover:bg-indigo-100 rounded text-indigo-700 font-bold border border-indigo-200"><input type="checkbox" id="multiSelectToggle" onchange="toggleMultiSelect()" aria-label="ëˆ„ì ëª¨ë“œ"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="autoScanToggle" onchange="toggleAutoScan()" aria-label="ìë™ìŠ¤ìº”"><span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="existingPlantToggle" onchange="toggleLayer('existing')" checked aria-label="ê¸°ì„¤ì¹˜"><span class="flex items-center gap-1"><i class="ph ph-lightning"></i> ê¸°ì„¤ì¹˜ ë°œì „ì†Œ</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="substationToggle" onchange="toggleLayer('substation')" checked aria-label="ë³€ì „ì†Œ"><span class="flex items-center gap-1"><i class="ph ph-circuitry"></i> ë³€ì „ì†Œ/ì„ ë¡œ</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mt-1 bg-red-50 hover:bg-red-100 rounded text-red-600 font-bold border border-red-100"><input type="checkbox" id="cadastralToggle" onchange="toggleLayer('cadastral')" checked aria-label="ì§€ì ë„"><span class="flex items-center gap-1"><i class="ph ph-map-trifold"></i> ì§€ì ë„ (ON)</span></label>
        <hr class="my-2 border-gray-200">
        <div class="space-y-1">
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="setMap('sat')" aria-label="ìœ„ì„±ì§€ë„"> <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="setMap('base')" aria-label="ì¼ë°˜ì§€ë„"> <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden flex items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText">ë©”ì‹œì§€</span></div>
    <div id="map"></div>

    <script>
        const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F"; 
        const BACKEND_URL = "https://port-0-solar-server-mkiol9jsc308f567.sel3.cloudtype.app";
        const ENCODED_ADMIN_PW = "Wmlld2lzZTEyMyE=";
        let map, layers, selectableGroup, panelGroup, cadastralLayer, analysisMarker, analysisMarkerGroup, existingGroup, substationGroup;
        let scanTarget='building', currentAnalysisFeature=null, currentGeoState={x:0,y:0,rot:0}, autoScanMode=false, isMultiSelectMode=false, accumulatedPanelsCount=0, isLoggedIn=false, currentUser=null;
        let apiCounts = { vworld: 0, public: 0, ai: 0 };
        // [ì¤‘ë³µ ë°©ì§€]
        let selectedFeatureIds = new Set();
        let currentAnalysisData = {}; 
        
        function trackApi(type) { if(apiCounts[type]!==undefined) { apiCounts[type]++; const el=document.getElementById(`cnt-${type}`); if(el) el.innerText=apiCounts[type]; } }
        function showToast(m) { const t=document.getElementById('toastMsg'); t.classList.remove('hidden','flex'); t.classList.add('flex'); document.getElementById('toastText').innerText=m; setTimeout(()=>t.classList.add('hidden'),3000); }
        function logSystem(msg) { const w=document.getElementById('logWindow'); if(w) { const p=document.createElement('div'); p.innerText=`> ${msg}`; w.appendChild(p); w.scrollTop=w.scrollHeight; } }

        function toggleLayer(type) {
            if(!map) return;
            const center = map.getCenter();
            if(type === 'existing') {
                if(document.getElementById('existingPlantToggle').checked) { createMockMarkers(center, 'plant'); map.addLayer(existingGroup); }
                else { existingGroup.clearLayers(); map.removeLayer(existingGroup); }
            } else if(type === 'substation') {
                 if(document.getElementById('substationToggle').checked) { createMockMarkers(center, 'substation'); map.addLayer(substationGroup); }
                 else { substationGroup.clearLayers(); map.removeLayer(substationGroup); }
            } else if(type === 'cadastral') {
                 if(document.getElementById('cadastralToggle').checked) { if(!cadastralLayer._map) map.addLayer(cadastralLayer); }
                 else { if(cadastralLayer._map) map.removeLayer(cadastralLayer); }
            }
        }
        function createMockMarkers(center, type) {
            const group = type === 'plant' ? existingGroup : substationGroup;
            group.clearLayers();
            for(let i=0; i<3; i++) {
                const lat = center.lat + (Math.random() * 0.01 - 0.005);
                const lng = center.lng + (Math.random() * 0.01 - 0.005);
                const iconHtml = type === 'plant' ? `<div class="plant-marker w-6 h-6"><i class="ph ph-lightning text-white text-[10px]"></i></div>` : `<div class="substation-marker w-8 h-8"><i class="ph ph-circuitry text-white"></i></div>`;
                const icon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [24, 24] });
                L.marker([lat, lng], { icon: icon, title: type }).bindPopup(type === 'plant' ? "ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘" : "ë³€ì „ì†Œ").addTo(group);
            }
        }
        function onMapMoveEnd() { if(!autoScanMode || !isLoggedIn) return; scanBuildings(map.getCenter().lat, map.getCenter().lng); }

        function jsonpRequest(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = function(data) { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
                const script = document.createElement('script');
                script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
                script.onerror = () => { delete window[callbackName]; document.body.removeChild(script); reject(new Error('JSONP failed')); };
                document.body.appendChild(script);
            });
        }

        async function searchAddress() {
            trackApi('vworld');
            const query = document.getElementById('addrInput').value;
            if(!query) return showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            const loading = document.getElementById('loading');
            if(loading) { loading.classList.remove('hidden'); loading.querySelector('p').innerText="ì£¼ì†Œ í™•ì¸ ì¤‘..."; }
            
            try {
                const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(query)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
                const data = await jsonpRequest(url);
                if(data.response && data.response.status === 'OK') {
                    const { x, y } = data.response.result.point;
                    map.setView([parseFloat(y), parseFloat(x)], 18);
                    showToast("ì´ë™ ì™„ë£Œ (JSONP).");
                    setTimeout(() => scanBuildings(parseFloat(y), parseFloat(x)), 800);
                } else { showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
            } catch(e) { 
                try {
                     const res = await fetch(`${BACKEND_URL}/api/vworld/address?address=${encodeURIComponent(query)}`);
                     const data = await res.json();
                     if(data.response?.status === 'OK') {
                        const { x, y } = data.response.result.point;
                        map.setView([parseFloat(y), parseFloat(x)], 18);
                     }
                } catch(err) { showToast("ê²€ìƒ‰ ì‹¤íŒ¨"); }
            } finally { if(loading) loading.classList.add('hidden'); }
        }

        async function scanBuildings(lat, lng) {
            trackApi('vworld');
            if(!isMultiSelectMode) selectableGroup.clearLayers();
            const loading = document.getElementById('loading');
            if(loading) { loading.classList.remove('hidden'); loading.querySelector('p').innerText="ë°ì´í„° ë¶„ì„ ì¤‘..."; }

            if(analysisMarker && !isMultiSelectMode) map.removeLayer(analysisMarker);
            analysisMarker = L.marker([lat, lng]).addTo(map);

            const box = `${lng - 0.001},${lat - 0.001},${lng + 0.001},${lat + 0.001}`;
            try {
                // [ìˆ˜ì •] ëª¨ë“œì— ë”°ë¥¸ ë ˆì´ì–´ ì„ íƒ
                const layerName = scanTarget === 'land' ? 'LP_PA_CBND_BUBUN' : 'LT_C_SPBD';
                const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${layerName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=1000`;
                const data = await jsonpRequest(url);
                if(data.response?.status === 'OK') {
                    L.geoJSON(data.response.result.featureCollection.features, {
                        // [ìˆ˜ì •] í† ì§€ ëª¨ë“œ ìŠ¤íƒ€ì¼: í˜•ê´‘ ë…¹ìƒ‰ í…Œë‘ë¦¬ + íˆ¬ëª…ë„ 0.1
                        style: scanTarget === 'land' 
                            ? { color: '#39ff14', weight: 3, fillColor: '#22c55e', fillOpacity: 0.1 } 
                            : { color: '#3b82f6', weight: 2, fillOpacity: 0.2 },
                        onEachFeature: (feature, layer) => { layer.on('click', () => analyzeFeature(feature)); }
                    }).addTo(selectableGroup);
                }
            } catch(e) { console.error(e); } finally { if(loading) loading.classList.add('hidden'); }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            layers = { 
                base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`), 
                sat: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
                hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`) 
            };
            layers.sat.addTo(map);
            selectableGroup = L.layerGroup().addTo(map); panelGroup = L.layerGroup().addTo(map); existingGroup = L.layerGroup().addTo(map); substationGroup = L.layerGroup().addTo(map);
            cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', { layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', format: 'image/png', transparent: true, opacity: 0.7, key: VWORLD_TILE_KEY });
            map.addLayer(cadastralLayer);
            map.on('click', (e) => scanBuildings(e.latlng.lat, e.latlng.lng));
            map.on('moveend', onMapMoveEnd); 
            if(document.getElementById('existingPlantToggle').checked) toggleLayer('existing');
            if(document.getElementById('substationToggle').checked) toggleLayer('substation');
            updateHistoryList();
            updateEstimatedTime(); 
            logSystem("Map Initialized.");
        }

        // Login Logic
        function attemptLogin() {
            const id = document.getElementById('userId').value.trim(), pw = document.getElementById('userPw').value.trim();
            let users = JSON.parse(localStorage.getItem('scenergy_users'));
            if (!users || users.length === 0) { users = [{id:"admin", pw:"1234"}]; localStorage.setItem('scenergy_users', JSON.stringify(users)); }
            const user = users.find(u => u.id === id && u.pw === pw);
            if(user) loginSuccess(user.id); else alert("ì •ë³´ ë¶ˆì¼ì¹˜");
        }
        function loginSuccess(u) { isLoggedIn = true; currentUser = u; document.getElementById('login-overlay').classList.add('hidden-overlay'); setTimeout(() => document.getElementById('login-overlay').style.display='none', 500); initMap(); }
        function logout() { location.reload(); }
        function showAdminLogin() { document.getElementById('step-user-login').classList.add('hidden'); document.getElementById('step-admin-login').classList.remove('hidden'); }
        function verifyAdmin() { if(btoa(document.getElementById('adminPw').value) === ENCODED_ADMIN_PW) enterAdmin(); else alert("ë¹„ë²ˆ ì˜¤ë¥˜"); }
        function enterAdmin() { document.getElementById('step-admin-login').classList.add('hidden'); document.getElementById('step-admin-dashboard').classList.remove('hidden'); renderUsers(); }
        function exitAdminMode() { document.getElementById('step-admin-login').classList.add('hidden'); document.getElementById('step-admin-dashboard').classList.add('hidden'); document.getElementById('step-user-login').classList.remove('hidden'); }
        function addUser() {
            const id = document.getElementById('newUserId').value, pw = document.getElementById('newUserPw').value;
            if(!id || !pw) return;
            let users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
            users.push({id, pw}); localStorage.setItem('scenergy_users', JSON.stringify(users));
            renderUsers();
        }
        function renderUsers() {
            const users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
            document.getElementById('user-list-container').innerHTML = users.map(u => `<div class="flex justify-between bg-slate-800 p-1 rounded text-xs text-cyan-300"><span>${u.id}</span></div>`).join('');
            document.getElementById('user-count').innerText = `${users.length}ëª…`;
        }

        async function analyzeFeature(feature) {
            // [ì¤‘ë³µ ë°©ì§€ & ìŠ¤ë§ˆíŠ¸ í† ê¸€]
            const featureId = feature.id || JSON.stringify(feature.geometry.coordinates);
            if (isMultiSelectMode && selectedFeatureIds.has(featureId)) { return showToast("ì´ë¯¸ ì„ íƒëœ ì˜ì—­ì…ë‹ˆë‹¤."); }
            if (!isMultiSelectMode) { selectedFeatureIds.clear(); }
            selectedFeatureIds.add(featureId);

            switchTab('analysis'); 
            document.getElementById('resultCard').classList.remove('hidden');
            const addr = feature.properties.road_nm_ad || feature.properties.jibun || feature.properties.addr || "ì£¼ì†Œ ë¯¸ìƒ";
            document.getElementById('analysisAddress').innerText = addr;
            
            // ë°ì´í„° ì €ì¥ìš© ê°ì²´ ì´ˆê¸°í™”
            currentAnalysisData = { address: addr, date: new Date().toLocaleDateString() };
            currentAnalysisFeature = feature;
            
            drawPanels(feature.geometry); 

            const center = turf.center(feature);
            const lng = center.geometry.coordinates[0];
            const lat = center.geometry.coordinates[1];

            const loadingEl = document.getElementById('legalLoading');
            const contentEl = document.getElementById('legalContent');
            const placeholderEl = document.getElementById('legalPlaceholder');
            
            if(placeholderEl) placeholderEl.classList.add('hidden');
            if(loadingEl) loadingEl.classList.remove('hidden');
            if(contentEl) contentEl.classList.add('hidden');

            try {
                // ë°±ì—”ë“œ ì¢…í•© ë¶„ì„ í˜¸ì¶œ
                const res = await fetch(`${BACKEND_URL}/api/analyze/comprehensive?lat=${lat}&lng=${lng}&address=${encodeURIComponent(addr)}`);
                const data = await res.json();
                
                if(loadingEl) loadingEl.classList.add('hidden');
                if(contentEl) contentEl.classList.remove('hidden');

                if(data.status === 'OK') {
                     // AI ë°ì´í„° ì €ì¥
                     currentAnalysisData.ai_analysis = data;
                     
                     // [ìˆ˜ì •] ì¼ì‚¬ëŸ‰ ë°˜ì˜í•˜ì—¬ ìˆ˜ìµ ì¬ê³„ì‚°
                     if(data.sun_hours) {
                         calculateFinance(accumulatedPanelsCount, data.sun_hours);
                     }

                     const resultContainer = document.getElementById('aiAnalysisResult');
                     if(resultContainer) {
                         const items = [
                            {icon: 'ph-buildings', title: 'ìš©ë„ì§€ì—­', val: data.zoning, link: data.links.eum},
                            {icon: 'ph-plant', title: 'ìƒíƒœë“±ê¸‰', val: data.eco_grade, link: data.links.heritage},
                            {icon: 'ph-gavel', title: 'ìì¹˜ì¡°ë¡€', val: 'í™•ì¸í•„ìš”', link: data.links.elis},
                            {icon: 'ph-lightning', title: 'í•œì „ìš©ëŸ‰', val: data.kepco_capacity, link: data.links.kepco},
                            {icon: 'ph-warning', title: 'í™˜ê²½ì˜í–¥í‰ê°€', val: data.env_assessment, link: '#'},
                            {icon: 'ph-mountains', title: 'ê²½ì‚¬ë„', val: 'ì§€ìì²´ë³„ ìƒì´(15~25ë„)', link: data.links.neins},
                            {icon: 'ph-sun', title: 'ì¼ì‚¬ëŸ‰', val: `${data.sun_hours}ì‹œê°„/ì¼`, link: '#'},
                            {icon: 'ph-scroll', title: 'ìƒìœ„ë²•ê·œ', val: 'ë²•ì œì²˜ í™•ì¸', link: 'https://www.law.go.kr/'}
                         ];
                         
                         resultContainer.innerHTML = items.map(item => `
                            <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded bg-slate-600 flex items-center justify-center text-cyan-400"><i class="ph ${item.icon}"></i></div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold">${item.title}</div>
                                        <div class="text-[10px] text-white truncate w-24" title="${item.val}">${item.val}</div>
                                    </div>
                                </div>
                                <a href="${item.link}" target="_blank" class="text-[9px] bg-slate-600 hover:bg-slate-500 px-1.5 py-0.5 rounded text-white transition">ì´ë™</a>
                            </div>
                         `).join('');
                     }
                     
                     if (data.kepco_capacity) {
                        const kepcoEl = document.getElementById('kepcoCapacity');
                        if(kepcoEl) kepcoEl.innerText = data.kepco_capacity;
                     }
                }
            } catch(e) {
                if(loadingEl) loadingEl.classList.add('hidden');
                if(contentEl) contentEl.classList.remove('hidden');
            }
        }
        
        // [ìˆ˜ì •] ëª¨ë“œ ë³€ê²½ ì‹œ ë¦¬ì…‹ ë° í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function toggleTarget() { 
            const els=document.getElementsByName('scanTarget'); 
            els.forEach(e=>{if(e.checked) scanTarget=e.value;}); 
            clearResults(); 
            showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === 'land' ? 'í† ì§€' : 'ì§€ë¶•'}`); 
        }

        function reCalculate() { if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry); }
        
        function calculateFinance(count, sunHoursOverride) { 
            const countEl = document.getElementById('analysisCount');
            if(countEl) countEl.innerText = `${count} ì¥`; 
            
            const modPower = parseFloat(document.getElementById('modPower').value) || 0;
            const capKw = (count * modPower) / 1000;
            const capEl = document.getElementById('analysisCapacity');
            if(capEl) capEl.innerText = `${capKw.toFixed(1)} kW`;

            // PF ê³„ì‚° (ROI ê³µì‹ ìˆ˜ì •ë¨)
            const smp = parseFloat(document.getElementById('smp').value);
            const rec = parseFloat(document.getElementById('rec').value);
            const costPerKw = parseFloat(document.getElementById('costPerKw').value) * 10000;
            const modPrice = parseFloat(document.getElementById('modPrice').value);
            const pfRatio = parseFloat(document.getElementById('pfLoanRatio').value);
            const pfRate = parseFloat(document.getElementById('pfInterestRate').value);
            
            // [ì¤‘ìš”] ì¼ì‚¬ëŸ‰ ë°˜ì˜ (ê¸°ë³¸ 3.6ì‹œê°„ -> APIê°’)
            const sunHours = sunHoursOverride || 3.6;
            const annualRev = capKw * sunHours * 365 * (smp + rec);
            
            const constructionCost = (capKw * costPerKw);
            const moduleCost = (count * modPower) * modPrice;
            const totalCost = constructionCost + moduleCost;
            const loanAmount = totalCost * (pfRatio / 100);
            const equityAmount = totalCost - loanAmount;
            const annualInterest = loanAmount * (pfRate / 100);
            const netIncome = annualRev - annualInterest;
            const pfPayback = netIncome > 0 ? (totalCost / netIncome).toFixed(1) : 99; // ì´ì‚¬ì—…ë¹„ íšŒìˆ˜ ê¸°ì¤€

            document.getElementById('resTotalCost').innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
            document.getElementById('resAnnualRev').innerText = `${Math.round(annualRev).toLocaleString()} ì›`;
            document.getElementById('resLoanAmount').innerText = `${Math.round(loanAmount).toLocaleString()} ì›`;
            document.getElementById('resEquityAmount').innerText = `${Math.round(equityAmount).toLocaleString()} ì›`;
            document.getElementById('resInterest').innerText = `${Math.round(annualInterest).toLocaleString()} ì›`;
            document.getElementById('resPfPayback').innerText = `${pfPayback} ë…„`;

            currentAnalysisData.finance = {
                capacity: `${capKw.toFixed(1)} kW`,
                totalCost: `${Math.round(totalCost).toLocaleString()} ì›`,
                annualRev: `${Math.round(annualRev).toLocaleString()} ì›`,
                loan: `${Math.round(loanAmount).toLocaleString()} ì›`,
                equity: `${Math.round(equityAmount).toLocaleString()} ì›`,
                interest: `${Math.round(annualInterest).toLocaleString()} ì›`,
                netIncome: `${Math.round(netIncome).toLocaleString()} ì›`,
                payback: `${pfPayback} ë…„`
            };
            currentAnalysisData.capacity = `${capKw.toFixed(1)} kW`;
        }
        
        // [ìˆ˜ì •] íŒ¨ë„ ê·¸ë¦¬ê¸° (ë ˆì´ì–´ ë¦¬í„´í•˜ë„ë¡ ë³€ê²½)
        function drawPanels(geo) { 
            // ë‹¨ì¼ ëª¨ë“œì¼ ë•Œë§Œ ì—¬ê¸°ì„œ ì´ˆê¸°í™” (ë©€í‹° ëª¨ë“œëŠ” analyzeFeatureì—ì„œ ì œì–´)
            // if(!isMultiSelectMode) { panelGroup.clearLayers(); accumulatedPanelsCount=0; } 
            
            try { 
                let poly = turf.feature(geo);
                if (currentGeoState.x !== 0 || currentGeoState.y !== 0 || currentGeoState.rot !== 0) {
                      poly = turf.transformRotate(poly, currentGeoState.rot);
                      if(currentGeoState.x !== 0) poly = turf.transformTranslate(poly, currentGeoState.x / 5000, 90);
                      if(currentGeoState.y !== 0) poly = turf.transformTranslate(poly, currentGeoState.y / 5000, 0);
                }

                const modW_m = parseFloat(document.getElementById('modWidth').value) || 1.13;
                const modH_m = parseFloat(document.getElementById('modHeight').value) || 2.4;
                const angle = parseFloat(document.getElementById('installAngle').value) || 20;
                
                const projectedH_m = modH_m * Math.cos(angle * Math.PI / 180);
                const ONE_LAT_M = 111000;
                const ONE_LNG_M = 88800;
                const dLng = (modW_m + 0.1) / ONE_LNG_M; 
                const dLat = (projectedH_m + 0.1) / ONE_LAT_M;
                
                const bbox = turf.bbox(poly);
                let tempPanels = [];
                let count = 0;
                let loopGuard = 0;

                for(let x = bbox[0]; x < bbox[2]; x += dLng) {
                    for(let y = bbox[1]; y < bbox[3]; y += dLat) {
                        loopGuard++;
                        if(loopGuard > 15000) break; 
                        const centerPt = turf.point([x + dLng/2, y + dLat/2]);
                        if(turf.booleanPointInPolygon(centerPt, poly)) {
                            const cell = turf.bboxPolygon([x, y, x + dLng*0.9, y + dLat*0.9]);
                            tempPanels.push(cell);
                            count++;
                        }
                    }
                    if(loopGuard > 15000) break;
                }
                
                let newLayer;
                if(tempPanels.length > 0) {
                    newLayer = L.geoJSON({type:"FeatureCollection", features: tempPanels}, {
                        style: scanTarget === 'land' 
                            ? { color: '#14532d', weight: 1, fillColor: '#16a34a', fillOpacity: 0.8 } // í† ì§€: ì§„í•œ ì´ˆë¡ íŒ¨ë„
                            : { color: '#1e40af', weight: 1, fillColor: '#3b82f6', fillOpacity: 0.7 } // ì§€ë¶•: íŒŒë€ íŒ¨ë„
                    });
                } else {
                    const center = turf.center(poly);
                    const [cx, cy] = center.geometry.coordinates;
                    const fallback = turf.bboxPolygon([cx, cy, cx+dLng, cy+dLat]);
                    newLayer = L.geoJSON(fallback, { style: { color: 'red', fillColor: '#ef4444' } });
                    count = 1;
                    showToast("ê±´ë¬¼ì´ ì‘ì•„ íŒ¨ë„ 1ê°œë¥¼ ì„ì‹œ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤.");
                }
                
                // ë ˆì´ì–´ë¥¼ ê·¸ë£¹ì— ì¶”ê°€
                newLayer.addTo(panelGroup);
                
                // ê²°ê³¼ ë°˜í™˜ (analyzeFeatureì—ì„œ ì‚¬ìš©)
                return { layer: newLayer, count: count };
                
            } catch(e) { console.error("Panel Draw Error:", e); return null; } 
        }

        function openFullReport() {
            if (!currentAnalysisData.finance) return showToast("ë¨¼ì € ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.");
            document.getElementById('form_address').value = currentAnalysisData.address;
            document.getElementById('form_capacity').value = currentAnalysisData.capacity;
            document.getElementById('form_kepco').value = document.getElementById('kepcoCapacity').innerText;
            document.getElementById('form_date').value = currentAnalysisData.date;
            document.getElementById('form_finance').value = JSON.stringify(currentAnalysisData.finance);
            document.getElementById('form_ai').value = JSON.stringify(currentAnalysisData.ai_analysis || {});
            
            document.getElementById('reportForm').action = BACKEND_URL + "/report";
            document.getElementById('reportForm').submit();
        }

        function saveResult() {
            const addr = document.getElementById('analysisAddress').innerText;
            const cap = document.getElementById('analysisCapacity').innerText;
            const rev = document.getElementById('resAnnualRev').innerText;
            if(addr === '-' || addr === 'ì£¼ì†Œ ë¯¸ìƒ') return showToast("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            let history = JSON.parse(localStorage.getItem('scenergy_history') || "[]");
            history.push({ date: new Date().toLocaleDateString(), address: addr, capacity: cap, revenue: rev });
            localStorage.setItem('scenergy_history', JSON.stringify(history));
            updateHistoryList();
            showToast("ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function updateHistoryList() {
            const listEl = document.getElementById('historyList');
            if(!listEl) return;
            const history = JSON.parse(localStorage.getItem('scenergy_history') || "[]");
            if(history.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            listEl.innerHTML = history.map((h, i) => `
                <div class="bg-slate-50 p-2 rounded border border-slate-200 text-xs mb-1">
                    <div class="font-bold text-slate-700">${h.address}</div>
                    <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                        <span>${h.capacity}</span><span>${h.revenue}</span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('scenergy_history');
                updateHistoryList();
            }
        }

        function updateEstimatedTime() {
            const delay = parseInt(document.getElementById('scanDelay').value) || 1000;
            const timerEl = document.getElementById('timerRemaining');
            if(timerEl) timerEl.innerText = `ì•½ ${Math.floor((delay * 20) / 1000 / 60).toString().padStart(2, '0')}:${Math.floor((delay * 20) / 1000 % 60).toString().padStart(2, '0')} ì†Œìš”`;
        }

        // [ìˆ˜ì •] ë¦¬ì…‹ ë²„íŠ¼: ë§ˆì»¤ì™€ ì¤‘ë³µ ì„ íƒ ëª©ë¡ê¹Œì§€ ì´ˆê¸°í™” (í•€í¬ì¸íŠ¸ ì œê±°)
        function clearResults() { 
            panelGroup.clearLayers(); 
            selectableGroup.clearLayers(); 
            accumulatedPanelsCount=0; 
            selectedFeatureIds.clear(); 
            if(analysisMarkerGroup) analysisMarkerGroup.clearLayers(); // [ìˆ˜ì •] ë§ˆì»¤ ê·¸ë£¹ìœ¼ë¡œ ì œê±°
            document.getElementById('resultCard').classList.add('hidden'); 
            currentAnalysisData = {};
        }
        function resetCalibration() { currentGeoState={x:0,y:0,rot:0}; if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry); }
        function applyCalibration(dx, dy, drot=0) { currentGeoState.x += dx * 5; currentGeoState.y += dy * 5; currentGeoState.rot += drot; if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry); }
        function applySliderCalibration(val, type) { const v=parseFloat(val); if(type==='x') currentGeoState.x=v*10; if(type==='y') currentGeoState.y=v*10; if(type==='rot') currentGeoState.rot=v; if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry); }
        function setRegion() { 
            const val=document.getElementById('regionSelect').value; 
            const REGIONS={
                'ansan_ind': [[37.31, 126.78], [37.31, 126.78]], 'incheon_ind': [[37.40, 126.70], [37.40, 126.70]], 'hwaseong_ind': [[37.20, 126.77], [37.20, 126.77]], 'pyeongtaek_ind': [[36.98, 126.85], [36.98, 126.85]],
                'cheonan_ind': [[36.85, 127.12], [36.85, 127.12]], 'osan_ind': [[36.72, 127.44], [36.72, 127.44]], 'daejeon_ind': [[36.43, 127.39], [36.43, 127.39]],
                'gumi_ind': [[36.11, 128.39], [36.11, 128.39]], 'changwon_ind': [[35.21, 128.65], [35.21, 128.65]], 'ulsan_ind': [[35.50, 129.37], [35.50, 129.37]], 'daegu_ind': [[35.85, 128.50], [35.85, 128.50]], 'pohang_ind': [[36.00, 129.37], [36.00, 129.37]],
                'gwangju_ind': [[35.20, 126.80], [35.20, 126.80]], 'yeosu_ind': [[34.85, 127.70], [34.85, 127.70]], 'daebul_ind': [[34.77, 126.45], [34.77, 126.45]], 'gunsan_ind': [[35.97, 126.60], [35.97, 126.60]],
                'seoul': [[37.5665, 126.9780], [37.5665, 126.9780]], 'gyeonggi': [[37.2752, 127.0097], [37.2752, 127.0097]], 'incheon': [[37.4563, 126.7052], [37.4563, 126.7052]],
                'jeonnam': [[34.8163, 126.4629], [34.8163, 126.4629]], 'jeonbuk': [[35.8203, 127.1087], [35.8203, 127.1087]], 'gyeongnam': [[35.2383, 128.6924], [35.2383, 128.6924]], 'gyeongbuk': [[36.5741, 128.5093], [36.5741, 128.5093]],
                'chungnam': [[36.6588, 126.6728], [36.6588, 126.6728]], 'chungbuk': [[36.6356, 127.4913], [36.6356, 127.4913]], 'gangwon': [[37.8854, 127.7298], [37.8854, 127.7298]], 'jeju': [[33.4996, 126.5312], [33.4996, 126.5312]]
            };

            const bounds=REGIONS[val]; 
            if(bounds) { if(bounds[0][0]===bounds[1][0]) { map.setView(bounds[0], 13); scanBuildings(bounds[0][0], bounds[0][1]); } else map.fitBounds(bounds); showToast("ì§€ì—­ ì´ë™"); }
        }
        function setMap(t) { if(t==='base') { map.addLayer(layers.base); map.removeLayer(layers.sat); } else { map.addLayer(layers.sat); map.removeLayer(layers.base); } layers.hybrid.bringToFront(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); document.getElementById('sidebar-toggle-btn').classList.toggle('collapsed'); }
        function switchTab(m) { ['scan','analysis','legal','history'].forEach(t=>document.getElementById(`tab-${t}`).classList.remove('active')||document.getElementById(`panel-${t}`).classList.add('hidden')); document.getElementById(`tab-${m}`).classList.add('active'); document.getElementById(`panel-${m}`).classList.remove('hidden'); }
        function toggleTarget() { const els=document.getElementsByName('scanTarget'); els.forEach(e=>{if(e.checked) scanTarget=e.value;}); toggleMultiSelect(); showToast(`ëª¨ë“œ: ${scanTarget}`); }
        function toggleMultiSelect() { isMultiSelectMode=document.getElementById('multiSelectToggle').checked; clearResults(); }
        function toggleAutoScan() { autoScanMode=document.getElementById('autoScanToggle').checked; if(autoScanMode) onMapMoveEnd(); }
        
        let missionInterval;
        async function startMission() {
            if(missionInterval) return;
            const bounds = map.getBounds();
            const latStep = (bounds.getNorth() - bounds.getSouth()) / 4;
            const lngStep = (bounds.getEast() - bounds.getWest()) / 5;
            let count = 0;
            const delay = parseInt(document.getElementById('scanDelay').value) || 1000;
            
            showToast("ìë™ ìŠ¤ìº” ì‹œì‘");
            document.getElementById('foundCount').innerText = "ê²€ìƒ‰ ì¤‘..."; // [ì¶”ê°€] ì´ˆê¸° í…ìŠ¤íŠ¸

            missionInterval = setInterval(() => {
                if(count >= 20) { clearInterval(missionInterval); missionInterval=null; showToast("ìŠ¤ìº” ì™„ë£Œ"); return; }
                const r = Math.floor(count / 5);
                const c = count % 5;
                const lat = bounds.getSouth() + latStep * (r + 0.5);
                const lng = bounds.getWest() + lngStep * (c + 0.5);
                scanBuildings(lat, lng);
                
                // [ì¶”ê°€] ì°¾ì€ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (selectableGroup ë ˆì´ì–´ ìˆ˜ ì¹´ìš´íŠ¸)
                const found = selectableGroup.getLayers().length;
                document.getElementById('foundCount').innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${found}ê°œ`;

                count++;
                document.getElementById('progressCount').innerText = `${count} / 20`;
                document.getElementById('totalProgressBar').style.width = `${(count/20)*100}%`;
            }, delay);
        }
    </script>
</body>
</html>
