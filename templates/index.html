<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Pathfinder Cloud (V158 + Legal)</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
        
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        
        /* UI ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; }
        
        /* ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        .log-line { font-family: monospace; font-size: 11px; border-bottom: 1px solid #333; padding: 3px 0; }
        .log-ok { color: #4ade80; } 
        .log-err { color: #f87171; } 
        .log-sys { color: #38bdf8; font-weight: bold; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #1e293b; }

        /* Leaflet ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ìˆ˜ì • */
        .leaflet-top.leaflet-right { top: 80px; right: 10px; }
        
        .legal-box { font-size: 11px; line-height: 1.5; color: #cbd5e1; }
        .legal-highlight { color: #f87171; font-weight: bold; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        
        <!-- í—¤ë” -->
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="ph ph-shield-check text-cyan-400"></i> Solar Pathfinder
            </h1>
            <div class="flex justify-between items-center mt-1">
                <p class="text-[10px] text-slate-400">V158 (Legal API Integrated)</p>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] text-green-400 font-bold">LIVE</span>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ (3ê°œë¡œ í™•ì¥) -->
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button onclick="switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-gavel text-lg"></i>ì¡°ë¡€/ê·œì œ</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
            
            <!-- ì„¤ì • íŒ¨ë„ -->
            <details class="bg-white rounded-lg border border-slate-200 shadow-sm group">
                <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50">
                    <span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„° ì„¤ì •</span>
                    <i class="ph ph-caret-down group-open:rotate-180 transition"></i>
                </summary>
                <div class="p-3 pt-0 space-y-3">
                    <div class="bg-indigo-50 p-2 rounded border border-indigo-100 text-xs">
                        <div class="font-bold text-indigo-700 mb-1 flex items-center gap-1"><i class="ph ph-ruler"></i> ë°°ì¹˜ ì„¤ì •</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center"></div>
                            <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div><label class="block mb-0.5 text-[10px] text-slate-500">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center"></div>
                             <div><label class="block mb-0.5 text-[10px] text-slate-500">ì´ê²© ê±°ë¦¬(m)</label><input type="number" id="rowSpacing" value="1.0" step="0.1" class="w-full border p-1 rounded text-center"></div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-2 rounded border border-green-200 text-xs">
                        <div class="font-bold text-green-700 mb-1 flex items-center gap-1"><i class="ph ph-currency-krw"></i> ê¸ˆìœµ/ìˆ˜ìµ ì„¤ì •</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€(ì›/W)</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700"></div>
                            <div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œì›/kW)</label><input type="number" id="costPerKw" value="100" class="w-full border p-1 rounded text-center"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2">
                            <div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œë¹„ìœ¨(%)</label><input type="number" id="pfLoanRatio" value="80" class="w-full border p-1 rounded text-center text-blue-600 font-bold"></div>
                            <div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold"></div>
                        </div>
                    </div>
                </div>
            </details>

            <div class="flex gap-2 text-xs">
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="toggleTarget()">
                    <div class="text-center py-2 border rounded bg-white peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 hover:bg-gray-50 transition shadow-sm">
                        <i class="ph ph-tree"></i> í† ì§€ (Land)
                    </div>
                </label>
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="toggleTarget()" checked>
                    <div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm">
                        <i class="ph ph-factory"></i> ì§€ë¶• (Roof)
                    </div>
                </label>
            </div>

            <!-- [íƒ­ A] ìŠ¤ìº” íŒ¨ë„ -->
            <div id="panel-scan" class="space-y-4">
                <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                    <h3 class="text-xs font-bold text-gray-700 mb-2">ğŸ“ ì§€ì—­ ì„ íƒ (ì „ìˆ˜ ì¡°ì‚¬)</h3>
                    <select id="regionSelect" onchange="setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none border-blue-200 focus:border-blue-500">
                        <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        <optgroup label="ğŸ­ ì£¼ìš” ì‚°ì—…ë‹¨ì§€">
                            <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                            <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                            <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                        </optgroup>
                        <optgroup label="ğŸŒ² ë„ (Provinces)">
                            <option value="gyeonggi">ê²½ê¸°ë„</option>
                            <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                            <option value="chungnam">ì¶©ì²­ë‚¨ë„</option>
                        </optgroup>
                        <option value="korea">ëŒ€í•œë¯¼êµ­ ì „ì²´</option>
                    </select>
                </div>
                <!-- ... ìŠ¤ìº” ì»¨íŠ¸ë¡¤ UI (ê¸°ì¡´ ë™ì¼) ... -->
                <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                    <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                        <span class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</span>
                        <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="updateEstimatedTime()">
                            <option value="1000">1ì´ˆ</option>
                            <option value="3000">3ì´ˆ</option>
                            <option value="5000">5ì´ˆ</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-end">
                        <div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">--:--:--</div>
                        <div id="progressCount" class="text-[10px] text-gray-500 font-mono">0 / 0 êµ¬ì—­</div>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                        <div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 pt-1">
                        <button onclick="startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs disabled:bg-slate-600 transition shadow" disabled>â–¶ ìŠ¤ìº” ì‹œì‘</button>
                        <button onclick="pauseMission()" id="pauseBtn" class="bg-red-500 hover:bg-red-600 py-2 rounded font-bold text-xs hidden transition shadow">â¸ ì¤‘ì§€</button>
                        <button onclick="resetMission()" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition shadow">ğŸ”„ ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>

            <!-- [íƒ­ B] ë¶„ì„ ë¦¬í¬íŠ¸ -->
            <div id="panel-analysis" class="hidden space-y-4">
                <!-- ê²°ê³¼ ì¹´ë“œ -->
                <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                    <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">
                        <i class="ph ph-trend-up text-cyan-400"></i> í†µí•© ë¶„ì„ ë¦¬í¬íŠ¸
                    </h3>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between items-start"><span class="text-slate-400 shrink-0">ğŸ“ ì£¼ì†Œ:</span><span id="analysisAddress" class="font-bold text-right text-white break-keep">-</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-400 shrink-0">âš¡ í•œì „ìš©ëŸ‰:</span><span id="analysisKepco" class="font-bold text-yellow-400">-</span></div>
                        <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">ğŸ“¦ ì„¤ì¹˜ëŸ‰:</span><span id="analysisCount" class="font-bold text-base font-mono">0 ì¥</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-400">ğŸ”‹ ì„¤ë¹„ìš©ëŸ‰:</span><span id="analysisCapacity" class="font-bold text-cyan-400 text-base font-mono">0 kW</span></div>
                    </div>
                    
                    <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600">
                        <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                        <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’° ì—° ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                    </div>

                    <!-- PF ìƒì„¸ -->
                    <div class="bg-indigo-900/40 p-2 rounded space-y-1 border border-indigo-500/30 text-[10px]">
                        <div class="flex justify-between text-indigo-300 font-bold border-b border-indigo-500/30 pb-1 mb-1">
                            <span>ğŸ¦ PF ê¸ˆìœµêµ¬ì¡° (<span id="pfRatioDisplay">80</span>%)</span>
                        </div>
                        <div class="flex justify-between"><span class="text-slate-400">ëŒ€ì¶œê¸ˆ:</span><span id="resLoanAmount" class="text-white">0 ì›</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">ìê¸°ìë³¸:</span><span id="resEquityAmount" class="text-white">0 ì›</span></div>
                        <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1">
                            <span class="text-indigo-200 font-bold">ğŸš€ PF íšŒìˆ˜ê¸°ê°„:</span>
                            <span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [íƒ­ C] ì¡°ë¡€/ê·œì œ (NEW) -->
            <div id="panel-legal" class="hidden space-y-4">
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg border-l-4 border-yellow-500 text-white min-h-[300px]">
                    <h3 class="text-sm font-bold flex items-center gap-2 border-b border-slate-700 pb-2 mb-3">
                        <i class="ph ph-gavel text-yellow-400"></i> ì§€ìì²´ ì´ê²©ê±°ë¦¬ ì¡°ë¡€
                    </h3>
                    
                    <div id="legalLoading" class="hidden text-center py-10">
                        <div class="spinner mx-auto mb-2"></div>
                        <p class="text-xs text-slate-400">êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„° ì¡°íšŒ ì¤‘...</p>
                    </div>

                    <div id="legalContent" class="space-y-3 hidden">
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-slate-400">ëŒ€ìƒ ì§€ì—­:</span>
                            <span id="legalRegion" class="font-bold text-yellow-300">ì§€ì—­ ë¯¸ì„ íƒ</span>
                        </div>
                        <div class="bg-slate-900/50 p-2 rounded text-xs text-cyan-300 font-bold mb-2 flex items-center gap-1">
                            <i class="ph ph-book-bookmark"></i> <span id="legalName">-</span>
                        </div>
                        <div id="legalArticles" class="legal-box h-60 overflow-y-auto bg-slate-900 p-3 rounded border border-slate-700">
                            <!-- ì¡°ë¡€ ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê° -->
                        </div>
                        <div class="text-[10px] text-slate-500 text-right mt-1">
                            * êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„°(law.go.kr) API ì œê³µ
                        </div>
                    </div>
                    
                    <div id="legalEmpty" class="text-center py-10 text-slate-500 text-xs">
                        <i class="ph ph-warning-circle text-2xl mb-2"></i><br>
                        ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ë©´<br>í•´ë‹¹ ì§€ìì²´ì˜ ì¡°ë¡€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="bg-white p-3 rounded border border-gray-200 flex gap-2 items-center shadow-sm">
                <button onclick="clearResults()" class="w-10 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded text-xs font-bold shadow flex items-center justify-center"><i class="ph ph-trash"></i></button>
                <div class="flex items-center px-3 bg-white border rounded shadow-inner">
                    <span id="resultCount" class="text-lg font-bold text-blue-700 mr-1 font-mono">0</span>
                    <span class="text-[10px] text-gray-500 uppercase font-bold">ê±´</span>
                </div>
            </div>
            
             <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="spinner mb-2"></div>
                <p class="text-xs text-slate-500">ì„œë²„ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>
        </div>

        <!-- ë¡œê·¸ì°½ -->
        <div class="h-32 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow">
            <div class="text-green-500">> Pathfinder V158 System Ready.</div>
        </div>
    </div>
    
    <div onclick="document.getElementById('sidebar').classList.toggle('collapsed')" class="absolute left-[420px] top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center z-[1999] border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600">
        <i class="ph ph-caret-left font-bold"></i>
    </div>

    <!-- ê²€ìƒ‰ì°½ (ìƒë‹¨ ìš°ì¸¡) -->
    <div class="absolute top-5 right-5 z-[1000] flex flex-col items-end gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" 
                   class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium"
                   onkeypress="if(event.key==='Enter') searchAddress()">
            <button onclick="searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md">
                <i class="ph ph-magnifying-glass font-bold"></i>
            </button>
        </div>
        
        <!-- ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ -->
        <div class="bg-white p-2 rounded shadow-lg border border-gray-200 text-xs w-40 mt-1">
             <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded font-bold text-slate-500">
                <input type="checkbox" id="autoScanToggle" onchange="toggleAutoScan()">
                <span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded font-bold text-slate-500">
                <input type="checkbox" id="existingPlantToggle" checked onchange="toggleLayer('existing')">
                <span class="flex items-center gap-1"><i class="ph ph-circle-dashed"></i> ê¸°ì„¤ì¹˜ ë°œì „ì†Œ</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded font-bold text-red-500 bg-red-50 border border-red-100">
                <input type="checkbox" id="cadastralToggle" onchange="toggleLayer('cadastral')" checked>
                <span class="flex items-center gap-1"><i class="ph ph-map-trifold"></i> ì§€ì ë„ (í† ì§€)</span>
            </label>
            <hr class="my-1 border-gray-100">
            <label class="flex items-center gap-2 cursor-pointer p-1"><input type="radio" name="mapL" value="sat" checked onchange="setMap('sat')"> <span>ìœ„ì„± ì§€ë„</span></label>
            <label class="flex items-center gap-2 cursor-pointer p-1"><input type="radio" name="mapL" value="base" onchange="setMap('base')"> <span>2D ì¼ë°˜ ì§€ë„</span></label>
        </div>
    </div>
    
    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden flex items-center gap-2 border border-cyan-500">
        <i class="ph ph-info text-cyan-400"></i>
        <span class="font-bold text-sm" id="toastText">ë©”ì‹œì§€</span>
    </div>

    <div id="map"></div>

    <script>
        const getApiBase = () => {
            const h = window.location.hostname;
            if (h === 'localhost' || h === '127.0.0.1' || window.location.protocol === 'file:') return 'http://localhost:5000';
            return '';
        };
        const API_BASE = getApiBase();
        const VWORLD_TILE_KEY = "8D526307-78EE-3281-8AB3-0D36115D17C3";

        let map, layers, selectableGroup, panelGroup, existingGroup, cadastralLayer, activeRect, analysisMarker;
        let missionQueue = []; let currentIndex = 0; let isRunning = false; let foundData = new Map();
        let scanTarget = 'building'; let autoScanMode = false; let scanTimer = null;
        let currentAnalysisFeature = null; let currentGeoState = { x:0, y:0, rot:0 };
        
        const preLoadedPlants = [
            {lat: 37.6631, lng: 126.6575}, {lat: 37.5955, lng: 126.6081}
        ];

        const REGIONS = {
            'ansan_ind': [[37.28, 126.70, 37.34, 126.85]],
            'korea': [[33.00, 124.50, 38.90, 131.00]]
        };
        const GRID_SIZE = 0.004;

        window.onload = function() {
            initMap();
            log(`System Ready. API Base: ${API_BASE || 'Cloud'}`);
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.control.scale({ position: 'bottomleft' }).addTo(map);

            layers = {
                base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`, { maxZoom: 19 }),
                sat: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`, { maxZoom: 19 }),
                hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`, { maxZoom: 19 })
            };
            layers.sat.addTo(map); layers.hybrid.addTo(map);
            
            cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', {
                layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
                styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
                format: 'image/png',
                transparent: true,
                opacity: 0.7,
                key: VWORLD_TILE_KEY
            });
            
            selectableGroup = L.layerGroup().addTo(map);
            panelGroup = L.layerGroup().addTo(map);
            existingGroup = L.layerGroup().addTo(map);

            if(document.getElementById('cadastralToggle').checked) map.addLayer(cadastralLayer);

            map.on('click', onMapClick);
            map.on('moveend', onMapMoveEnd);
        }

        async function searchAddress() {
            const query = document.getElementById('addrInput').value;
            if(!query) return showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                const res = await fetch(`${API_BASE}/api/vworld/address?address=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error("Net Err");
                const data = await res.json();
                
                if(data.response?.status === 'OK') {
                    const { x, y } = data.response.result.point;
                    map.setView([y, x], 19);
                    scanBuildings(y, x);
                    // ê²€ìƒ‰ ì‹œ ì¡°ë¡€ë„ ê°™ì´ ê²€ìƒ‰
                    fetchLegalInfo(query);
                } else {
                    showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch(e) { log("Address API Fail", "err"); }
        }

        function onMapClick(e) {
            scanBuildings(e.latlng.lat, e.latlng.lng);
        }

        async function scanBuildings(lat, lng) {
            selectableGroup.clearLayers();
            panelGroup.clearLayers();
            document.getElementById('loading').classList.remove('hidden');
            
            if(analysisMarker) map.removeLayer(analysisMarker);
            analysisMarker = L.marker([lat, lng]).addTo(map);

            const delta = 0.002;
            const box = `${lng - delta},${lat - delta},${lng + delta},${lat + delta}`;
            const layerName = scanTarget === 'building' ? 'LT_C_SPBD' : 'LP_PA_CBND_BUBUN';
            
            try {
                const res = await fetch(`${API_BASE}/api/vworld/data?data=${layerName}&geomFilter=BOX(${box})`);
                const data = await res.json();
                document.getElementById('loading').classList.add('hidden');

                if(data.response?.status === 'OK') {
                    const features = data.response.result.featureCollection.features;
                    L.geoJSON(features, {
                        style: { color: "#38bdf8", weight: 2, fillOpacity: 0.1, dashArray: '4' },
                        onEachFeature: (feature, layer) => {
                            layer.on('click', (e) => { L.DomEvent.stopPropagation(e); analyzeFeature(feature); });
                        }
                    }).addTo(selectableGroup);
                    
                    if(features.length > 0) analyzeFeature(features[0]);
                } else {
                    showToast("ë¶„ì„ ëŒ€ìƒ ì—†ìŒ");
                }
            } catch(e) { document.getElementById('loading').classList.add('hidden'); }
        }

        async function analyzeFeature(feature) {
            currentAnalysisFeature = JSON.parse(JSON.stringify(feature));
            switchTab('analysis'); // íƒ­ ì „í™˜
            resetCalibration(false); 
            
            document.getElementById('resultCard').classList.remove('hidden');
            const props = feature.properties;
            const addr = props.addr || props.road_nm_ad || props.jibun || "ì£¼ì†Œ ë¯¸ìƒ";
            document.getElementById('analysisAddress').innerText = addr;
            
            // ì¡°ë¡€ ì •ë³´ë„ ì—…ë°ì´íŠ¸
            fetchLegalInfo(addr);

            // í•œì „ ìš©ëŸ‰
            const pnu = props.pnu;
            document.getElementById('analysisKepco').innerText = "ì¡°íšŒ ì¤‘...";
            if(pnu) {
                try {
                    const res = await fetch(`${API_BASE}/api/kepco?pnu=${pnu}`);
                    const data = await res.json();
                    if(data.response?.body?.items?.item) {
                        const item = Array.isArray(data.response.body.items.item) ? data.response.body.items.item[0] : data.response.body.items.item;
                        document.getElementById('analysisKepco').innerText = `${parseInt(item.ableCapacity).toLocaleString()} kW`;
                    } else {
                        document.getElementById('analysisKepco').innerText = "0 kW";
                    }
                } catch(e) { document.getElementById('analysisKepco').innerText = "ì¡°íšŒ ì‹¤íŒ¨"; }
            } else {
                document.getElementById('analysisKepco').innerText = "PNU ì—†ìŒ";
            }

            drawPanels(feature.geometry);
        }

        // [NEW] ë²•ë ¹/ì¡°ë¡€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function fetchLegalInfo(address) {
            document.getElementById('legalEmpty').classList.add('hidden');
            document.getElementById('legalContent').classList.add('hidden');
            document.getElementById('legalLoading').classList.remove('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/api/ordinance?address=${encodeURIComponent(address)}`);
                const data = await res.json();
                
                document.getElementById('legalLoading').classList.add('hidden');
                document.getElementById('legalContent').classList.remove('hidden');
                
                if(data.result === 'OK') {
                    document.getElementById('legalRegion').innerText = data.region;
                    document.getElementById('legalName').innerText = data.law_name;
                    
                    const container = document.getElementById('legalArticles');
                    container.innerHTML = "";
                    data.articles.forEach(art => {
                        container.innerHTML += `<div class="mb-3 border-b border-slate-800 pb-2">${art}</div>`;
                    });
                } else {
                    document.getElementById('legalRegion').innerText = data.region || "í™•ì¸ ë¶ˆê°€";
                    document.getElementById('legalName').innerText = "ì •ë³´ ì—†ìŒ";
                    document.getElementById('legalArticles').innerHTML = `<div class="text-slate-500">${data.msg || "ì¡°ë¡€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."}</div>`;
                }
            } catch(e) {
                console.error(e);
                document.getElementById('legalLoading').classList.add('hidden');
                document.getElementById('legalArticles').innerHTML = `<div class="text-red-400">ì„œë²„ í†µì‹  ì˜¤ë¥˜</div>`;
            }
        }

        function drawPanels(geometry) {
            // ... (ê¸°ì¡´ íŒ¨ë„ ë°°ì¹˜ ë¡œì§ ë™ì¼) ...
            panelGroup.clearLayers();
            try {
                let poly = turf.feature(geometry);
                if (currentGeoState.x !== 0 || currentGeoState.y !== 0 || currentGeoState.rot !== 0) {
                     poly = turf.transformRotate(poly, currentGeoState.rot);
                     poly = turf.transformTranslate(poly, currentGeoState.x / 1000, 90); 
                     poly = turf.transformTranslate(poly, currentGeoState.y / 1000, 0); 
                }

                const modW = (parseFloat(document.getElementById('modWidth').value) || 1.13) / 111000;
                const modH = (parseFloat(document.getElementById('modHeight').value) || 2.4) / 111000;
                const spacing = (parseFloat(document.getElementById('rowSpacing').value) || 1.0) / 111000;
                
                const bbox = turf.bbox(poly);
                let panels = [];
                
                for(let y = bbox[1]; y < bbox[3]; y += (modH + spacing)) {
                    for(let x = bbox[0]; x < bbox[2]; x += (modW + 0.000005)) {
                        const cell = turf.polygon([[[x, y], [x + modW, y], [x + modW, y + modH], [x, y + modH], [x, y]]]);
                        if(turf.booleanPointInPolygon(turf.centroid(cell), poly)) panels.push(cell);
                    }
                }

                if(panels.length > 0) {
                    L.geoJSON({type:"FeatureCollection", features: panels}, {
                        style: { color: '#3b82f6', weight: 1, fillColor: '#2563eb', fillOpacity: 0.8 }
                    }).addTo(panelGroup);
                }

                const count = panels.length;
                const modPower = parseFloat(document.getElementById('modPower').value);
                const capKw = (count * modPower) / 1000;
                
                const smp = parseFloat(document.getElementById('smp').value);
                const costPerKw = parseFloat(document.getElementById('costPerKw').value) * 10000;
                const modPrice = parseFloat(document.getElementById('modPrice').value);
                const pfRatio = parseFloat(document.getElementById('pfLoanRatio').value);
                const pfRate = parseFloat(document.getElementById('pfInterestRate').value);

                const annualRev = capKw * 3.6 * 365 * smp;
                const constructionCost = capKw * costPerKw;
                const moduleCost = (count * modPower) * modPrice;
                const totalCost = constructionCost + moduleCost;
                const loanAmount = totalCost * (pfRatio / 100);
                const equityAmount = totalCost - loanAmount;
                const annualInterest = loanAmount * (pfRate / 100);
                const netIncome = annualRev - annualInterest;
                const pfPayback = netIncome > 0 ? (equityAmount / netIncome).toFixed(1) : 99;

                document.getElementById('analysisCount').innerText = `${count} ì¥`;
                document.getElementById('analysisCapacity').innerText = `${capKw.toFixed(1)} kW`;
                document.getElementById('resAnnualRev').innerText = `${Math.round(annualRev).toLocaleString()} ì›`;
                document.getElementById('resTotalCost').innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
                document.getElementById('pfRatioDisplay').innerText = pfRatio;
                document.getElementById('resLoanAmount').innerText = `${Math.round(loanAmount).toLocaleString()} ì›`;
                document.getElementById('resEquityAmount').innerText = `${Math.round(equityAmount).toLocaleString()} ì›`;
                document.getElementById('resInterest').innerText = `${Math.round(annualInterest).toLocaleString()} ì›`;
                document.getElementById('resPfPayback').innerText = `${pfPayback} ë…„`;
                
                document.getElementById('resultCount').innerText = 1;

            } catch(e) { console.error(e); }
        }

        function applyCalibration(dx, dy, drot=0) {
            currentGeoState.x += dx; currentGeoState.y += dy; currentGeoState.rot += drot;
            if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }
        function resetCalibration(redraw=true) {
            currentGeoState = { x:0, y:0, rot:0 };
            if(redraw && currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }

        function setRegion() {
            const val = document.getElementById('regionSelect').value;
            if(!val) return;
            const boundsList = REGIONS[val];
            if(boundsList) {
                const b = boundsList[0];
                map.fitBounds([[b[0], b[1]], [b[2], b[3]]]);
            }
        }

        function updateEstimatedTime() {
            // (ê°„ì†Œí™”: íƒ€ì´ë¨¸ ë¡œì§ì€ ìœ ì§€í•˜ë˜ ì‹¤ì œ êµ¬í˜„ì€ ìƒëµ)
        }

        function startMission() { /* ... */ }
        function pauseMission() { /* ... */ }
        function resetMission() { /* ... */ }

        function switchTab(mode) {
            ['scan', 'analysis', 'legal'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`panel-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById(`panel-${mode}`).classList.remove('hidden');
        }
        function toggleTarget() {
            const els = document.getElementsByName('scanTarget');
            els.forEach(e => { if(e.checked) scanTarget = e.value; });
        }
        function toggleLayer(type) {
            if(type === 'existing') {
                document.getElementById('existingPlantToggle').checked ? map.addLayer(existingGroup) : map.removeLayer(existingGroup);
            }
            if(type === 'cadastral') {
                 if(document.getElementById('cadastralToggle').checked) {
                     if(!cadastralLayer._map) map.addLayer(cadastralLayer);
                 } else {
                     if(cadastralLayer._map) map.removeLayer(cadastralLayer);
                 }
            }
        }
        function setMap(type) {
            if(type === 'base') { map.addLayer(layers.base); map.removeLayer(layers.sat); }
            else { map.addLayer(layers.sat); map.removeLayer(layers.base); }
            layers.hybrid.bringToFront();
        }
        function showToast(msg) {
            const el = document.getElementById('toastMsg');
            document.getElementById('toastText').innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        function downloadCSV() { /* ... */ }
        function clearResults() {
            if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                panelGroup.clearLayers();
                document.getElementById('resultCount').innerText = "0";
            }
        }
        function toggleAutoScan() {
            autoScanMode = document.getElementById('autoScanToggle').checked;
            if(autoScanMode) onMapMoveEnd();
        }
        function onMapMoveEnd() {
            if(!autoScanMode) return;
            const c = map.getCenter();
            scanBuildings(c.lat, c.lng);
        }
        function log(msg, type = 'info') {
            const win = document.getElementById('logWindow');
            if(win) {
                win.innerHTML += `<div class="log-line ${type === 'err' ? 'log-err' : 'log-ok'}">> ${msg}</div>`;
                win.scrollTop = win.scrollHeight;
            }
        }
    </script>
</body>
</html>
