<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- https ê°•ì œ ì—…ê·¸ë ˆì´ë“œ (Mixed Content ë°©ì§€) -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    
    <!-- Firebase SDK (9.x Compat ë²„ì „) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ (ë¡¤ë°±ë¨) */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); /* Slate-900 with opacity */
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        #login-overlay.hidden-overlay {
            opacity: 0; pointer-events: none;
        }

        /* ì‚¬ì´ë“œë°” ì• ë‹ˆë©”ì´ì…˜ */
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        
        /* ì‚¬ì´ë“œë°” ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ */
        #sidebar-toggle-btn {
            left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001;
        }
        #sidebar-toggle-btn.collapsed { left: 0; }
        #sidebar-toggle-btn.collapsed i { transform: rotate(180deg); }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        
        /* ê²°ê³¼ ì¹´ë“œ */
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }

        /* D-Pad ë²„íŠ¼ */
        .d-pad-btn {
            width: 24px; height: 24px; background: #e2e8f0; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.1s; color: #334155; font-size: 10px;
        }
        .d-pad-btn:hover { background: #cbd5e1; color: #0f172a; }
        .d-pad-btn:active { background: #94a3b8; transform: scale(0.95); }

        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #06b6d4; cursor: pointer; margin-top: -4px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px;
        }

        /* ê¸°ì„¤ì¹˜ ë°œì „ì†Œ/ë³€ì „ì†Œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .plant-marker { 
            background: #fbbf24; border: 2px solid white; border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; 
        }
        .substation-marker {
            background: #ef4444; border: 2px solid white; border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center;
        }
        
        /* Input ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .login-input {
            background: rgba(30, 41, 59, 0.5); border: 1px solid #475569; color: white;
            transition: all 0.3s;
        }
        .login-input:focus { border-color: #06b6d4; outline: none; background: rgba(30, 41, 59, 0.8); }

        /* ê´€ë¦¬ì íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .admin-panel-transition {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="login-overlay">
        <div class="bg-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-700 w-[400px] text-center relative overflow-hidden transition-all duration-300" id="login-box">
            <!-- ë°°ê²½ ë°ì½”ë ˆì´ì…˜ -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500"></div>
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl"></div>

            <div class="mb-6 relative">
                <div class="mx-auto w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-slate-700 shadow-lg">
                    <!-- ì•„ì´ì½˜ ë³€ê²½: íƒœì–‘ê´‘ íŒ¨ë„ (solar-panel) -->
                    <i class="ph ph-solar-panel text-3xl text-cyan-400" id="login-icon"></i>
                </div>
                <!-- íƒ€ì´í‹€ ë³€ê²½ -->
                <h1 class="text-2xl font-bold text-white tracking-tight" id="login-title">SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
                <p class="text-slate-400 text-sm mt-2" id="login-subtitle">íƒœì–‘ê´‘ ë°œì „ ë¶„ì„ í´ë¼ìš°ë“œ</p>
                
                <!-- ê´€ë¦¬ììš© ë‹«ê¸° ë²„íŠ¼ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                <button onclick="exitAdminMode()" id="exit-admin-btn" class="hidden absolute top-0 right-0 text-slate-500 hover:text-white">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <!-- [ì¼ë°˜ ì‚¬ìš©ì] ë¡œê·¸ì¸ í™”ë©´ -->
            <div id="step-user-login" class="space-y-4">
                <div class="space-y-3 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400 ml-1">ì•„ì´ë”” (ID)</label>
                        <input type="text" id="userId" placeholder="User ID" class="login-input w-full rounded px-4 py-3 text-sm mt-1" onkeypress="if(event.key==='Enter') document.getElementById('userPw').focus()">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 ml-1">ë¹„ë°€ë²ˆí˜¸ (Password)</label>
                        <input type="password" id="userPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="login-input w-full rounded px-4 py-3 text-sm mt-1" onkeypress="if(event.key==='Enter') attemptLogin()">
                    </div>
                </div>

                <button onclick="attemptLogin()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-cyan-900/20 flex items-center justify-center gap-2 mt-2">
                    <i class="ph ph-sign-in"></i> ì ‘ì†í•˜ê¸°
                </button>
                
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-700/50">
                    <p class="text-[10px] text-slate-500 text-left">* ê´€ë¦¬ìê°€ ë“±ë¡í•œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                    <button onclick="showAdminLogin()" class="text-[10px] text-slate-500 hover:text-cyan-400 transition font-bold flex items-center gap-1">
                        <i class="ph ph-lock-key"></i> ê´€ë¦¬ì ë¡œê·¸ì¸
                    </button>
                </div>
            </div>

            <!-- [ê´€ë¦¬ì] ë¡œê·¸ì¸ í™”ë©´ -->
            <div id="step-admin-login" class="hidden space-y-4">
                <div class="text-left">
                    <label class="text-xs font-bold text-red-400 ml-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPw" class="login-input w-full rounded px-4 py-3 text-sm font-mono mt-1" placeholder="Password" onkeypress="if(event.key==='Enter') verifyAdmin()">
                </div>
                <button onclick="verifyAdmin()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-red-900/20 flex items-center justify-center gap-2">
                    <i class="ph ph-key"></i> ê´€ë¦¬ì ì ‘ì†
                </button>
                <button onclick="exitAdminMode()" class="text-xs text-slate-400 hover:text-white">
                    ëŒì•„ê°€ê¸°
                </button>
            </div>

            <!-- [ê´€ë¦¬ì] ëŒ€ì‹œë³´ë“œ (ìœ ì € ê´€ë¦¬) -->
            <div id="step-admin-dashboard" class="hidden space-y-4">
                <div class="bg-slate-800/50 rounded-lg p-3 text-left border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">ì‹ ê·œ ìœ ì € ë“±ë¡</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="newUserId" placeholder="ì•„ì´ë””" class="login-input rounded px-2 py-1.5 text-xs">
                        <input type="text" id="newUserPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="login-input rounded px-2 py-1.5 text-xs">
                    </div>
                    <button onclick="addUser()" class="w-full bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-xs font-bold">ìœ ì € ì¶”ê°€</button>
                </div>

                <div class="text-left">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">ë“±ë¡ëœ ìœ ì € ëª©ë¡</label>
                    <div class="bg-slate-800 rounded border border-slate-700 h-32 overflow-y-auto p-2 space-y-1" id="user-list-container">
                        <!-- JSë¡œ ëª©ë¡ ë Œë”ë§ -->
                    </div>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="exitAdminMode()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs">ë‚˜ê°€ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        
        <!-- í—¤ë” -->
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°
                <span class="text-[10px] bg-cyan-900 text-cyan-300 px-1.5 py-0.5 rounded ml-auto">PRO</span>
            </h1>
            
            <div class="flex justify-between items-center text-[10px] text-slate-400 mt-2 border-t border-slate-700 pt-2">
                <span id="currentUserDisplay">Not Logged In</span>
                <button onclick="logout('Manual')" class="text-red-400 hover:text-red-300 underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- API Status Box -->
            <div class="mt-3 bg-slate-800/50 p-2 rounded border border-slate-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[9px] text-slate-400">API Connection Status</span>
                    <span class="text-[9px] text-green-400 font-bold flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> ONLINE
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-1 text-center">
                    <div class="bg-slate-900 rounded p-1 border border-slate-700">
                        <div class="text-[8px] text-slate-500 mb-0.5">V-World</div>
                        <div id="cnt-vworld" class="text-[10px] font-mono font-bold text-cyan-400">0</div>
                    </div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700">
                        <div class="text-[8px] text-slate-500 mb-0.5">Public Data</div>
                        <div id="cnt-public" class="text-[10px] font-mono font-bold text-yellow-400">0</div>
                    </div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700">
                        <div class="text-[8px] text-slate-500 mb-0.5">SolarAI</div>
                        <div id="cnt-ai" class="text-[10px] font-mono font-bold text-purple-400">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button onclick="switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center flex flex-col items-center gap-1 text-gray-600 hover:bg-gray-50"><i class="ph ph-sparkle text-lg text-purple-600"></i>AI ì¡°ë¡€ë¶„ì„</button>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ (í•­ìƒ í‘œì‹œ, ìŠ¤í¬ë¡¤ ì˜ì—­ ìƒë‹¨) -->
        <div class="flex-1 overflow-y-auto bg-slate-50">
            <div class="p-4 pb-0">
                <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4" open>
                    <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg">
                        <span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„° (ì„¤ì •)</span>
                        <i class="ph ph-caret-down group-open:rotate-180 transition"></i>
                    </summary>
                    <div class="p-3 space-y-3 border-t border-gray-200">
                        
                        <!-- 1. ëª¨ë“ˆ ë¬¼ë¦¬ì  ì„¤ì • -->
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100 text-xs">
                            <div class="font-bold text-indigo-700 mb-1 flex items-center gap-1"><i class="ph ph-ruler"></i> ëª¨ë“ˆ ë° ì„¤ì¹˜ ê·œê²©</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ë†’ì´(m)</label><input type="number" id="installHeight" value="0.5" step="0.1" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                 <div><label class="block mb-0.5 text-[10px] text-slate-500">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                                 <div><label class="block mb-0.5 text-[10px] text-slate-500">ì´ê²© ê±°ë¦¬(m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                            </div>
                        </div>

                        <!-- 2. ê¸ˆìœµ ì„¤ì • -->
                        <div class="bg-green-50 p-2 rounded border border-green-200 text-xs">
                            <div class="font-bold text-green-700 mb-1 flex items-center gap-1"><i class="ph ph-currency-krw"></i> ê¸ˆìœµ/ìˆ˜ìµ ì„¤ì •</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€(ì›/W)</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700 bg-white" onchange="reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œì›/kW)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="block mb-0.5 text-[10px]">SMP(ì›/kWh)</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px]">REC(ì›/kWh)</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center bg-white" onchange="reCalculate()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2">
                                <div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œë¹„ìœ¨(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center text-blue-600 font-bold bg-white" onchange="reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold bg-white" onchange="reCalculate()"></div>
                            </div>
                        </div>
                    </div>
                </details>

                <div class="flex gap-2 text-xs mb-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="toggleTarget()">
                        <div class="text-center py-2 border rounded bg-white peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 hover:bg-gray-50 transition shadow-sm">
                            <i class="ph ph-tree"></i> í† ì§€ (Land)
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="toggleTarget()" checked>
                        <div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm">
                            <i class="ph ph-factory"></i> ì§€ë¶• (Roof)
                        </div>
                    </label>
                </div>
            </div>

            <!-- íƒ­ ì½˜í…ì¸  -->
            <div class="px-4 pb-4">
                
                <!-- [íƒ­ A] ìŠ¤ìº” íŒ¨ë„ -->
                <div id="panel-scan" class="space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <h3 class="text-xs font-bold text-gray-700 mb-2">ğŸ“ ì§€ì—­ ì„ íƒ</h3>
                        <select id="regionSelect" onchange="setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none border-blue-200 focus:border-blue-500">
                            <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì§€ë°© ì£¼ìš” ì‚°ë‹¨">
                                <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                <option value="yeosu_ind">ì—¬ìˆ˜ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="gunsan_ind">êµ°ì‚° êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                <option value="gyeonggi">ê²½ê¸°ë„</option>
                                <option value="incheon">ì¸ì²œê´‘ì—­ì‹œ</option>
                                <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                <option value="gyeongbuk">ê²½ìƒë¶ë„</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                        <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                            <span class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</span>
                            <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="updateEstimatedTime()">
                                <option value="1000">1ì´ˆ</option>
                                <option value="3000">3ì´ˆ</option>
                                <option value="5000">5ì´ˆ</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-end">
                            <div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div>
                            <div id="progressCount" class="text-[10px] text-gray-500 font-mono">0 / 20 êµ¬ì—­</div>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button onclick="startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition shadow">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                            <button onclick="clearResults()" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition shadow">ğŸ”„ ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>

                <!-- [íƒ­ B] ë¶„ì„ ë¦¬í¬íŠ¸ -->
                <div id="panel-analysis" class="hidden space-y-4">
                    <!-- ë³´ì • íˆ´ -->
                    <div class="bg-slate-800 p-2 rounded-lg border border-indigo-500/50 shadow-lg mb-2">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1">
                            <span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1">
                                <i class="ph ph-crosshair"></i> íŒ¨ë„ ìˆ˜ë™ ì¡°ì •
                            </span>
                            <button onclick="resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white transition border border-slate-600">ì´ˆê¸°í™”</button>
                        </div>
                        
                        <div class="space-y-2 mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-400 w-6">Xì¶•</span>
                                <input type="range" min="-50" max="50" value="0" step="1" oninput="applySliderCalibration(this.value, 'x')">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-400 w-6">Yì¶•</span>
                                <input type="range" min="-50" max="50" value="0" step="1" oninput="applySliderCalibration(this.value, 'y')">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-400 w-6">íšŒì „</span>
                                <input type="range" min="-180" max="180" value="0" step="1" oninput="applySliderCalibration(this.value, 'rot')">
                            </div>
                        </div>

                        <!-- ë¯¸ì„¸ ì¡°ì • D-Pad -->
                        <div class="flex gap-4 items-center justify-center relative border-t border-slate-700 pt-2">
                            <div class="grid grid-cols-3 gap-1">
                                <div></div><div class="d-pad-btn" onclick="applyCalibration(0, 0.5)">â–²</div><div></div>
                                <div class="d-pad-btn" onclick="applyCalibration(-0.5, 0)">â—€</div>
                                <div class="w-6 h-6 flex items-center justify-center text-[9px] font-mono text-slate-400">Mov</div>
                                <div class="d-pad-btn" onclick="applyCalibration(0.5, 0)">â–¶</div>
                                <div></div><div class="d-pad-btn" onclick="applyCalibration(0, -0.5)">â–¼</div><div></div>
                            </div>
                            <div class="h-12 w-px bg-slate-600"></div>
                            <div class="flex flex-col gap-1">
                                <div class="d-pad-btn w-16" onclick="applyCalibration(0, 0, -1)">â†º -1Â°</div>
                                <div class="d-pad-btn w-16" onclick="applyCalibration(0, 0, 1)">â†» +1Â°</div>
                            </div>
                        </div>
                    </div>

                    <!-- ê²°ê³¼ ì¹´ë“œ -->
                    <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                        <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">
                            <i class="ph ph-trend-up text-cyan-400"></i> í†µí•© ë¶„ì„ ê²°ê³¼
                        </h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between items-start"><span class="text-slate-400 shrink-0">ğŸ“ ì£¼ì†Œ:</span><span id="analysisAddress" class="font-bold text-right text-white break-keep">-</span></div>
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">ğŸ“¦ ì´ ëª¨ë“ˆ ìˆ˜ëŸ‰:</span><span id="analysisCount" class="font-bold text-base font-mono">0 ì¥</span></div>
                            <div class="flex justify-between items-center"><span class="text-slate-400">ğŸ”‹ ì´ ì„¤ë¹„ ìš©ëŸ‰:</span><span id="analysisCapacity" class="font-bold text-cyan-400 text-base font-mono">0 kW</span></div>
                        </div>
                        
                        <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600">
                            <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                            <div class="flex justify-between text-xs"><span class="text-slate-400">ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                        </div>

                        <!-- PF ìƒì„¸ -->
                        <div class="bg-indigo-900/40 p-2 rounded space-y-1 border border-indigo-500/30 text-[10px]">
                            <div class="flex justify-between text-indigo-300 font-bold border-b border-indigo-500/30 pb-1 mb-1">
                                <span>ğŸ¦ PF ê¸ˆìœµêµ¬ì¡° (<span id="pfRatioDisplay">90</span>%)</span>
                            </div>
                            <div class="flex justify-between"><span class="text-slate-400">ëŒ€ì¶œê¸ˆ:</span><span id="resLoanAmount" class="text-white">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìê¸°ìë³¸:</span><span id="resEquityAmount" class="text-white">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ì—° ì´ì:</span><span id="resInterest" class="text-red-300">0 ì›</span></div>
                            <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1">
                                <span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span>
                                <span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [íƒ­ C] ì¡°ë¡€/ê·œì œ -->
                <div id="panel-legal" class="hidden space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg shadow-lg border-l-4 border-purple-500 text-white min-h-[300px]">
                        <h3 class="text-sm font-bold flex items-center gap-2 border-b border-slate-700 pb-2 mb-3">
                            <i class="ph ph-sparkle text-purple-400"></i> SolarAI ì¡°ë¡€ ë¶„ì„
                        </h3>
                        
                        <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                            <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>
                            ê±´ë¬¼ì„ ì„ íƒí•˜ë©´ SolarAIê°€<br>í•´ë‹¹ ì§€ìì²´ì˜ ìµœì‹  ì¡°ë¡€ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
                        </div>

                        <div id="legalLoading" class="hidden text-center py-10">
                            <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                            <p class="text-xs text-purple-300 animate-pulse">SolarAIê°€ ë²•ë ¹ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>

                        <div id="legalContent" class="hidden space-y-3">
                            <div class="bg-purple-900/30 p-2 rounded border border-purple-500/30 text-xs text-purple-200">
                                ğŸ¤– <span class="font-bold">SolarAI Analysis Result</span>
                            </div>
                            <div id="aiResponse" class="text-xs text-slate-300 leading-relaxed space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                            <div class="text-[10px] text-slate-500 text-right">
                                * Powered by SolarAI Engine
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                    <div class="spinner mb-2"></div>
                    <p class="text-xs text-slate-500">ê³µê°„ ì •ë³´ ë¶„ì„ ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë¡œê·¸ì°½ -->
        <div class="h-24 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow">
            <div class="text-green-500">> System Booting... Login Required.</div>
        </div>
    </div>
    
    <!-- ì‚¬ì´ë“œë°” ì ‘ê¸° ë²„íŠ¼ -->
    <div id="sidebar-toggle-btn" onclick="toggleSidebar()" class="absolute top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600">
        <i class="ph ph-caret-left font-bold transition-transform"></i>
    </div>

    <!-- ê²€ìƒ‰ì°½ (ì¤‘ì•™ ìƒë‹¨) -->
    <div class="absolute top-5 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col items-center gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" 
                   class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium"
                   onkeypress="if(event.key==='Enter') searchAddress()">
            <button onclick="searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md">
                <i class="ph ph-magnifying-glass font-bold"></i>
            </button>
        </div>
    </div>
    
    <!-- ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ (ìš°ì¸¡ ìƒë‹¨) -->
    <div class="absolute top-5 right-5 z-[1000] bg-white p-2 rounded-lg shadow-lg border border-gray-200 text-xs w-44">
        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1">
            <i class="ph ph-stack"></i> ë ˆì´ì–´ & ì§€ë„ ì„¤ì •
        </div>
        
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 hover:bg-indigo-100 rounded text-indigo-700 font-bold border border-indigo-200">
            <input type="checkbox" id="multiSelectToggle" onchange="toggleMultiSelect()">
            <span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span>
        </label>

        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="autoScanToggle" onchange="toggleAutoScan()">
            <span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="existingPlantToggle" onchange="toggleLayer('existing')" checked>
            <span class="flex items-center gap-1"><i class="ph ph-lightning"></i> ê¸°ì„¤ì¹˜ ë°œì „ì†Œ</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="substationToggle" onchange="toggleLayer('substation')" checked>
            <span class="flex items-center gap-1"><i class="ph ph-circuitry"></i> ë³€ì „ì†Œ/ì„ ë¡œ</span>
        </label>
        
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mt-1 bg-red-50 hover:bg-red-100 rounded text-red-600 font-bold border border-red-100">
            <input type="checkbox" id="cadastralToggle" onchange="toggleLayer('cadastral')" checked>
            <span class="flex items-center gap-1"><i class="ph ph-map-trifold"></i> ì§€ì ë„ (ON)</span>
        </label>

        <hr class="my-2 border-gray-200">
        
        <div class="space-y-1">
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                <input type="radio" name="mapL" value="sat" checked onchange="setMap('sat')"> 
                <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                <input type="radio" name="mapL" value="base" onchange="setMap('base')"> 
                <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span>
            </label>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden flex items-center gap-2 border border-cyan-500">
        <i class="ph ph-info text-cyan-400"></i>
        <span class="font-bold text-sm" id="toastText">ë©”ì‹œì§€</span>
    </div>

    <div id="map"></div>

    <script>
        // ==========================================
        //  ì„¤ì • ë° ê¸€ë¡œë²Œ ë³€ìˆ˜
        // ==========================================
        // [ì¤‘ìš”] V-World API í‚¤ ì˜¤ë¥˜ ì‹œ ë³¸ì¸ í‚¤ë¡œ êµì²´ í•„ìš”
        // ë°œê¸‰ ì£¼ì†Œ: https://www.vworld.kr/dev/v4dv_apikey_s001.do
        // ë°œê¸‰ ì‹œ 'í™œìš© URL'ì— ë³¸ì¸ ì›¹ì„œë²„ ì£¼ì†Œë¥¼ ê¼­ ë“±ë¡í•´ì•¼ í•¨ (ì˜ˆ: http://myserver.com)
        const VWORLD_TILE_KEY = "8D526307-78EE-3281-8AB3-0D36115D17C3"; 
        
        // [Firebase Config] 
        // ì œê³µí•´ì£¼ì‹  ì„¤ì •ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
        const firebaseConfig = {
            apiKey: "AIzaSyDEbyyoY-B3cHlfwi82ZXQSGMw8IyZt7Nw",
            authDomain: "solar-pathfinder.firebaseapp.com",
            projectId: "solar-pathfinder",
            storageBucket: "solar-pathfinder.firebasestorage.app",
            messagingSenderId: "477084185928",
            appId: "1:477084185928:web:b4fd4dd693ae149c392f7d"
        };
        
        // Firebase ì´ˆê¸°í™” ì‹œë„
        let app, auth, db;
        let isFirebaseActive = false;
        try {
            // í‚¤ê°€ ì‹¤ì œ ì…ë ¥ë˜ì—ˆëŠ”ì§€ ê°„ë‹¨íˆ ì²´í¬ (YOUR_API_KEYê°€ ì•„ë‹ ë•Œ)
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseActive = true;
                console.log("Firebase Connected: Multi-device session active.");
            } else {
                console.warn("Firebase Config Missing: Running in Local Simulation Mode.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        let map, layers, selectableGroup, panelGroup, cadastralLayer, analysisMarker;
        let existingGroup, substationGroup;
        let scanTarget = 'building'; 
        let currentAnalysisFeature = null; 
        let currentGeoState = { x:0, y:0, rot:0 };
        let autoScanMode = false;
        let isMultiSelectMode = false;
        let accumulatedPanelsCount = 0; 
        let apiCounts = { vworld: 0, public: 0, ai: 0 };
        let isLoggedIn = false;
        let currentUser = null;
        let sessionCheckInterval;

        // [ë³´ì•ˆ] ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ (Base64 Encoding)
        // ì›ë³¸: "Ziewise123!"
        // ì£¼ì˜: ì´ ë°©ì‹ì€ ì†ŒìŠ¤ì½”ë“œ ë‚œë…í™”ì¼ ë¿, ì™„ë²½í•œ ë³´ì•ˆì€ ì•„ë‹˜. ì‹¤ì œëŠ” ì„œë²„ ê²€ì¦ í•„ìˆ˜.
        const ENCODED_ADMIN_PW = "Wmlld2lzZTEyMyE="; 

        // ==========================================
        //  ë¡œê·¸ì¸ ë° ê´€ë¦¬ì ë¡œì§ (ID/PW)
        // ==========================================

        function attemptLogin() {
            const id = document.getElementById('userId').value.trim();
            const pw = document.getElementById('userPw').value.trim();
            
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            // 1. ë“±ë¡ëœ ìœ ì €ì¸ì§€ í™•ì¸ (Local Storage ì‚¬ìš©)
            const users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
            const user = users.find(u => u.id === id && u.pw === pw);

            if(user) {
                // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
                loginSuccess(user.id);
            } else {
                alert("ë“±ë¡ë˜ì§€ ì•Šì€ ì•„ì´ë””ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        function loginSuccess(userId) {
            isLoggedIn = true;
            currentUser = userId;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('login-overlay').classList.add('hidden-overlay');
            setTimeout(() => document.getElementById('login-overlay').style.display = 'none', 500);
            
            document.getElementById('currentUserDisplay').innerText = `User: ${userId}`;
            logSystem(`ë¡œê·¸ì¸ ì„±ê³µ: ${userId}`);

            // [ì¤‘ë³µ ë¡œê·¸ì¸ ë°©ì§€ í•µì‹¬ ë¡œì§]
            const sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);
            
            // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ (íƒ­ ê°„ ë™ê¸°í™”)
            localStorage.setItem('auth_session_token', sessionId);
            localStorage.setItem('auth_user_id', userId);

            // 2. íŒŒì´ì–´ë² ì´ìŠ¤ (ë‹¤ë¥¸ PC ê°„ ë™ê¸°í™”)
            if(isFirebaseActive) {
                db.collection('user_sessions').doc(userId).set({
                    sessionId: sessionId,
                    lastLogin: new Date().toISOString(),
                    device: navigator.userAgent
                });
                
                // ë‚´ ì„¸ì…˜ ê°ì‹œ ì‹œì‘
                monitorRemoteSession(userId, sessionId);
            } else {
                showToast("ì£¼ì˜: íŒŒì´ì–´ë² ì´ìŠ¤ ë¯¸ì—°ë™ (íƒ­ ê°„ ì¤‘ë³µ ë¡œê·¸ì¸ë§Œ ë°©ì§€ë¨)");
            }

            // ì§€ë„ ì´ˆê¸°í™”
            initMap();
            updateEstimatedTime();
        }

        // [ì¤‘ë³µ ë¡œê·¸ì¸ ê°ì§€ - ë¡œì»¬]
        window.addEventListener('storage', (e) => {
            if(e.key === 'auth_session_token' && isLoggedIn) {
                // ë‚´ê°€ ë°©ê¸ˆ ì„¤ì •í•œê²Œ ì•„ë‹Œë° í† í°ì´ ë°”ë€Œì—ˆë‹¤ë©´ -> ë‹¤ë¥¸ íƒ­ì—ì„œ ë¡œê·¸ì¸ í•¨
                alert("ë‹¤ë¥¸ ì°½ì—ì„œ ë¡œê·¸ì¸ì´ ê°ì§€ë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
                logout('Duplicate');
            }
        });

        // [ì¤‘ë³µ ë¡œê·¸ì¸ ê°ì§€ - ì›ê²© (Firestore)]
        function monitorRemoteSession(userId, mySessionId) {
            if(!isFirebaseActive) return;
            
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
            db.collection('user_sessions').doc(userId).onSnapshot((doc) => {
                if(doc.exists) {
                    const data = doc.data();
                    if(data.sessionId !== mySessionId) {
                        alert("ë‹¤ë¥¸ ê¸°ê¸°(PC/ëª¨ë°”ì¼)ì—ì„œ ì ‘ì†í•˜ì—¬ í˜„ì¬ ì„¸ì…˜ì´ ì¢…ë£Œë©ë‹ˆë‹¤.");
                        logout('Duplicate Remote');
                    }
                }
            });
        }

        function logout(reason) {
            isLoggedIn = false;
            currentUser = null;
            if(reason === 'Manual') {
                localStorage.removeItem('auth_session_token');
                localStorage.removeItem('auth_user_id');
            }
            location.reload(); // ê°€ì¥ ê¹”ë”í•œ ì´ˆê¸°í™”
        }

        // ==========================================
        //  ê´€ë¦¬ì ë¡œì§ (ìœ ì € ë“±ë¡)
        // ==========================================

        function showAdminLogin() {
            document.getElementById('step-user-login').classList.add('hidden');
            document.getElementById('step-admin-login').classList.remove('hidden');
            document.getElementById('login-title').innerText = "Administrator";
            document.getElementById('login-subtitle').innerText = "ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì ‘ì†";
            document.getElementById('login-icon').className = "ph ph-lock-key-open text-3xl text-red-400";
        }

        function verifyAdmin() {
            const inputPw = document.getElementById('adminPw').value;
            // [ë³´ì•ˆ] ì…ë ¥ê°’ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ (í‰ë¬¸ ë…¸ì¶œ ë°©ì§€)
            try {
                if (btoa(inputPw) === ENCODED_ADMIN_PW) {
                    enterAdminDashboard();
                } else {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    document.getElementById('adminPw').value = "";
                }
            } catch(e) {
                alert("ì¸ì¦ ì˜¤ë¥˜");
            }
        }

        function enterAdminDashboard() {
            document.getElementById('step-admin-login').classList.add('hidden');
            document.getElementById('step-admin-dashboard').classList.remove('hidden');
            document.getElementById('login-subtitle').innerText = "ìœ ì € ê³„ì • ê´€ë¦¬";
            document.getElementById('exit-admin-btn').classList.remove('hidden');
            renderUserList();
        }

        function addUser() {
            const id = document.getElementById('newUserId').value.trim();
            const pw = document.getElementById('newUserPw').value.trim();
            
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            
            const users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
            if(users.find(u => u.id === id)) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
            
            users.push({ id, pw });
            localStorage.setItem('scenergy_users', JSON.stringify(users));
            
            document.getElementById('newUserId').value = "";
            document.getElementById('newUserPw').value = "";
            renderUserList();
            alert(`ìœ ì € [${id}] ë“±ë¡ ì™„ë£Œ`);
        }

        function renderUserList() {
            const container = document.getElementById('user-list-container');
            const users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            if (document.getElementById('user-count')) {
                document.getElementById('user-count').innerText = `${users.length}ëª…`;
            }

            container.innerHTML = "";
            if(users.length === 0) {
                container.innerHTML = `<div class="text-[10px] text-slate-500 text-center py-4">ë“±ë¡ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            users.forEach((u, idx) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-slate-900/50 p-1.5 rounded border border-slate-700/50";
                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[10px] font-mono text-cyan-300 ml-1 font-bold">${u.id}</span>
                        <span class="text-[8px] text-slate-500 ml-1">PW: ****</span>
                    </div>
                    <button onclick="removeUser(${idx})" class="text-slate-500 hover:text-red-400 p-1"><i class="ph ph-trash"></i></button>
                `;
                container.appendChild(item);
            });
        }

        function removeUser(idx) {
            if(confirm("ì´ ìœ ì €ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const users = JSON.parse(localStorage.getItem('scenergy_users') || "[]");
                users.splice(idx, 1);
                localStorage.setItem('scenergy_users', JSON.stringify(users));
                renderUserList();
            }
        }

        function exitAdminMode() {
            document.getElementById('step-admin-login').classList.add('hidden');
            document.getElementById('step-admin-dashboard').classList.add('hidden');
            document.getElementById('step-user-login').classList.remove('hidden');
            
            // íƒ€ì´í‹€ ë³µêµ¬
            document.getElementById('login-title').innerText = "SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°";
            document.getElementById('login-subtitle').innerText = "íƒœì–‘ê´‘ ë°œì „ ë¶„ì„ í´ë¼ìš°ë“œ";
            document.getElementById('login-icon').className = "ph ph-solar-panel text-3xl text-cyan-400";
            
            document.getElementById('adminPw').value = "";
            document.getElementById('exit-admin-btn').classList.add('hidden');
        }

        function logSystem(msg) {
            const logWin = document.getElementById('logWindow');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            logWin.appendChild(p);
            logWin.scrollTop = logWin.scrollHeight;
        }

        // ==========================================
        //  ì§€ë„ ë° í•µì‹¬ ë¡œì§
        // ==========================================

        const REGIONS = {
            'ansan_ind': [[37.28, 126.70], [37.34, 126.85]],
            'incheon_ind': [[37.39, 126.68], [37.42, 126.73]],
            'hwaseong_ind': [[37.18, 126.75], [37.22, 126.80]],
            'pyeongtaek_ind': [[36.95, 126.83], [37.00, 126.90]],
            'seoul': [[37.5665, 126.9780], [37.5665, 126.9780]],
            'gyeonggi': [[37.2752, 127.0097], [37.2752, 127.0097]],
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
            L.control.zoom({ position: 'bottomright' }).addTo(map); 
            L.control.scale({ position: 'bottomleft', metric: true }).addTo(map);

            layers = {
                base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`, { maxZoom: 19 }),
                sat: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`, { maxZoom: 19 }),
                hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`, { maxZoom: 19 })
            };
            layers.sat.addTo(map); layers.hybrid.addTo(map);
            
            cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', {
                layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
                styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
                format: 'image/png',
                transparent: true,
                opacity: 0.7,
                key: VWORLD_TILE_KEY
            });
            map.addLayer(cadastralLayer);

            selectableGroup = L.layerGroup().addTo(map);
            panelGroup = L.layerGroup().addTo(map);
            existingGroup = L.layerGroup().addTo(map);
            substationGroup = L.layerGroup().addTo(map);

            map.on('click', onMapClick);
            map.on('moveend', onMapMoveEnd); 
            
            // ì´ˆê¸° ë ˆì´ì–´ ìƒíƒœ ë°˜ì˜
            if(document.getElementById('existingPlantToggle').checked) toggleLayer('existing');
            if(document.getElementById('substationToggle').checked) toggleLayer('substation');
            logSystem("Map Initialized. Ready to scan.");
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('sidebar-toggle-btn').classList.toggle('collapsed');
        }

        function trackApi(type) {
            if(apiCounts[type] !== undefined) {
                apiCounts[type]++;
                document.getElementById(`cnt-${type}`).innerText = apiCounts[type];
            }
        }

        async function fetchGeminiLegalAnalysis(address) {
            trackApi('ai');
            const loading = document.getElementById('legalLoading');
            const content = document.getElementById('legalContent');
            const placeholder = document.getElementById('legalPlaceholder');
            const responseDiv = document.getElementById('aiResponse');
            
            placeholder.classList.add('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            setTimeout(() => {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                
                let analysis = "";
                const addr = address || "";
                
                if(addr.includes("ì„œìš¸")) {
                    analysis = `<p class="font-bold text-yellow-300">ğŸ“Œ ì„œìš¸íŠ¹ë³„ì‹œ íƒœì–‘ê´‘ ì¡°ë¡€ ë¶„ì„</p><ul class="list-disc pl-4 mt-1 space-y-1"><li><span class="text-slate-200">ì…ì§€ ê·œì œ:</span> ë„ë¡œ/ì£¼ê±°ì§€ ì´ê²©ê±°ë¦¬ ê·œì œ ì™„í™” ì¶”ì„¸.</li><li><span class="text-slate-200">ì„¤ì¹˜ ì§€ì›:</span> 'ì„œìš¸í˜• í–‡ë¹›ë°œì „' ì§€ì› ëŒ€ìƒ ê°€ëŠ¥ì„± ë†’ìŒ.</li></ul>`;
                } else if(addr.includes("ê²½ê¸°") || addr.includes("ì•ˆì‚°") || addr.includes("í™”ì„±")) {
                     analysis = `<p class="font-bold text-yellow-300">ğŸ“Œ ê²½ê¸°ë„/ì‚°ì—…ë‹¨ì§€ ì¡°ë¡€ ë¶„ì„</p><ul class="list-disc pl-4 mt-1 space-y-1"><li><span class="text-slate-200">ì‚°ì—…ë‹¨ì§€ íŠ¹ë¡€:</span> ì§€ë¶•í˜• íƒœì–‘ê´‘ ì„¤ì¹˜ ì‹œ ì´ê²©ê±°ë¦¬ ê·œì œ ë©´ì œ.</li><li><span class="text-slate-200">ì¸ì„¼í‹°ë¸Œ:</span> ê²½ê¸°ë„ 'RE100' ì‚°ë‹¨ ì§€ì› ì‚¬ì—… ëŒ€ìƒì§€.</li></ul>`;
                } else {
                    analysis = `<p class="font-bold text-yellow-300">ğŸ“Œ ${addr.split(" ")[0]} ì§€ì—­ ì¡°ë¡€ ë¶„ì„</p><p>ì¼ë°˜ì ì¸ êµ­í† ê³„íšë²• ë° ê°œë°œí–‰ìœ„í—ˆê°€ ìš´ì˜ì§€ì¹¨ì„ ë”°ë¦…ë‹ˆë‹¤.</p>`;
                }
                responseDiv.innerHTML = analysis;
            }, 1500);
        }

        async function searchAddress() {
            trackApi('vworld');
            const query = document.getElementById('addrInput').value;
            if(!query) return showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            // [ì¤‘ìš”] V-World API í˜¸ì¶œ ì‹œ ì—ëŸ¬ê°€ ë‚˜ë©´ í‚¤ì™€ ë„ë©”ì¸ í™•ì¸ í•„ìš”
            const url = `https://api.vworld.kr/req/search?service=search&request=search&version=2.0&crs=EPSG:4326&size=1&page=1&query=${encodeURIComponent(query)}&type=place&format=json&errorformat=json&key=${VWORLD_TILE_KEY}`;
            
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                
                const data = await res.json();
                
                if(data.response.status === 'OK') {
                    const { x, y } = data.response.result.items[0].point;
                    map.setView([y, x], 18);
                    showToast("ì´ë™ ì™„ë£Œ.");
                    setTimeout(() => scanBuildings(y, x), 800);
                } else {
                    showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch(e) { 
                console.error("V-World API Error:", e);
                showToast("ê²€ìƒ‰ API ì˜¤ë¥˜: í‚¤ ë˜ëŠ” ë„ë©”ì¸ ì œí•œì„ í™•ì¸í•˜ì„¸ìš”."); 
            }
        }

        function onMapClick(e) {
            scanBuildings(e.latlng.lat, e.latlng.lng);
        }

        function onMapMoveEnd() {
            if(!autoScanMode || !isLoggedIn) return;
            const c = map.getCenter();
            scanBuildings(c.lat, c.lng);
        }

        async function scanBuildings(lat, lng) {
            trackApi('vworld');
            trackApi('public');
            
            if(!isMultiSelectMode) {
                selectableGroup.clearLayers();
            }
            
            document.getElementById('loading').classList.remove('hidden');
            
            if(analysisMarker && !isMultiSelectMode) map.removeLayer(analysisMarker);
            analysisMarker = L.marker([lat, lng]).addTo(map);

            const delta = 0.001; 
            const box = `${lng - delta},${lat - delta},${lng + delta},${lat + delta}`;
            const layerName = scanTarget === 'building' ? 'LT_C_SPBD' : 'LP_PA_CBND_BUBUN';
            
            const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${layerName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&domain=${window.location.hostname}`;

            try {
                const res = await fetch(url);
                if(res.ok) {
                    const data = await res.json();
                    if(data.response.status === 'OK') {
                        const features = data.response.result.featureCollection.features;
                        renderFeatures(features);
                        document.getElementById('loading').classList.add('hidden');
                    } else {
                        document.getElementById('loading').classList.add('hidden');
                        if(!autoScanMode) showToast("ë¶„ì„í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                } else { throw new Error("Net Err"); }
            } catch(e) {
                document.getElementById('loading').classList.add('hidden');
                console.error("V-World Data API Error:", e);
                if(!autoScanMode) showToast("ë°ì´í„° í˜¸ì¶œ ì‹¤íŒ¨ (CORS ë˜ëŠ” í‚¤ í™•ì¸)");
            }
        }

        function renderFeatures(features) {
            L.geoJSON(features, {
                style: { color: "#38bdf8", weight: 2, fillOpacity: 0.2, dashArray: '5, 5' },
                onEachFeature: (feature, layer) => {
                    layer.on('click', (e) => { 
                        L.DomEvent.stopPropagation(e); 
                        analyzeFeature(feature); 
                    });
                    if(features.indexOf(feature) === 0 && !autoScanMode) analyzeFeature(feature);
                }
            }).addTo(selectableGroup);
        }

        async function analyzeFeature(feature) {
            currentAnalysisFeature = JSON.parse(JSON.stringify(feature));
            
            if(!autoScanMode && !isMultiSelectMode) {
                switchTab('analysis'); 
                resetCalibration(false); 
                accumulatedPanelsCount = 0; 
            }
            
            document.getElementById('resultCard').classList.remove('hidden');
            const props = feature.properties || {};
            const addr = props.road_nm_ad || props.jibun || props.addr || "ì£¼ì†Œ ë¯¸ìƒ";
            
            if (isMultiSelectMode && accumulatedPanelsCount > 0) {
                document.getElementById('analysisAddress').innerText = `${addr} ì™¸ ë‹¤ìˆ˜`;
            } else {
                document.getElementById('analysisAddress').innerText = addr;
            }
            
            drawPanels(feature.geometry);
            if(!autoScanMode) fetchGeminiLegalAnalysis(addr);
        }

        function drawPanels(geometry) {
            if (!isMultiSelectMode) {
                panelGroup.clearLayers();
                accumulatedPanelsCount = 0;
            }

            try {
                let poly = turf.feature(geometry);
                
                if (currentGeoState.x !== 0 || currentGeoState.y !== 0 || currentGeoState.rot !== 0) {
                      poly = turf.transformRotate(poly, currentGeoState.rot);
                      poly = turf.transformTranslate(poly, currentGeoState.x / 100000, 90); 
                      poly = turf.transformTranslate(poly, currentGeoState.y / 100000, 0); 
                }

                const modW = (parseFloat(document.getElementById('modWidth').value) || 1.13) / 1000;
                const modH = (parseFloat(document.getElementById('modHeight').value) || 2.4) / 1000;
                const spacingVal = (parseFloat(document.getElementById('rowSpacing').value) || 1.2) / 1000;
                const angle = parseFloat(document.getElementById('installAngle').value) || 20;
                const projectedH = modH * Math.cos(angle * Math.PI / 180);

                const dLat = (projectedH + spacingVal) / 111; 
                const dLng = (modW + 0.00001) / 88; 
                
                const bbox = turf.bbox(poly);
                let currentBatchPanels = [];
                const stepX = dLng; 
                const stepY = dLat; 
                
                let loopCount = 0;
                const MAX_LOOPS = 5000; 

                for(let x = bbox[0]; x < bbox[2]; x += stepX) {
                    for(let y = bbox[1]; y < bbox[3]; y += stepY) {
                        loopCount++;
                        if(loopCount > MAX_LOOPS) break; 
                        const centerPt = turf.point([x + dLng/2, y + dLat/2]);
                        if(turf.booleanPointInPolygon(centerPt, poly)) {
                            const cell = turf.bboxPolygon([x, y, x + dLng*0.9, y + (projectedH/111)]);
                            currentBatchPanels.push(cell);
                        }
                    }
                    if(loopCount > MAX_LOOPS) break;
                }

                if(currentBatchPanels.length > 0) {
                    L.geoJSON({type:"FeatureCollection", features: currentBatchPanels}, {
                        style: { color: '#3b82f6', weight: 1, fillColor: '#1d4ed8', fillOpacity: 0.9 }
                    }).addTo(panelGroup);
                }
                
                accumulatedPanelsCount += currentBatchPanels.length;
                calculateFinance(accumulatedPanelsCount);

            } catch(e) { console.error("Error", e); }
        }

        function reCalculate() {
            if (isMultiSelectMode) {
                showToast("ì£¼ì˜: ëˆ„ì  ëª¨ë“œì—ì„œëŠ” ì„¤ì • ë³€ê²½ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
            if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }

        function calculateFinance(count) {
            const modPower = parseFloat(document.getElementById('modPower').value);
            const capKw = (count * modPower) / 1000;
            const smp = parseFloat(document.getElementById('smp').value);
            const rec = parseFloat(document.getElementById('rec').value);
            const costPerKw = parseFloat(document.getElementById('costPerKw').value) * 10000;
            const modPrice = parseFloat(document.getElementById('modPrice').value);
            const pfRatio = parseFloat(document.getElementById('pfLoanRatio').value);
            const pfRate = parseFloat(document.getElementById('pfInterestRate').value);
            
            const height = parseFloat(document.getElementById('installHeight').value) || 0;
            const heightCostBonus = height > 1.0 ? (height - 1.0) * 10000 * capKw : 0; 

            const totalUnitRevenue = smp + rec; 
            const annualRev = capKw * 3.6 * 365 * totalUnitRevenue;
            
            const constructionCost = (capKw * costPerKw) + heightCostBonus;
            const moduleCost = (count * modPower) * modPrice;
            const totalCost = constructionCost + moduleCost;
            
            const loanAmount = totalCost * (pfRatio / 100);
            const equityAmount = totalCost - loanAmount;
            const annualInterest = loanAmount * (pfRate / 100);
            const netIncome = annualRev - annualInterest;
            const pfPayback = netIncome > 0 ? (equityAmount / netIncome).toFixed(1) : 99;

            document.getElementById('analysisCount').innerText = `${count.toLocaleString()} ì¥`;
            document.getElementById('analysisCapacity').innerText = `${capKw.toFixed(1)} kW`;
            document.getElementById('resAnnualRev').innerText = `${Math.round(annualRev).toLocaleString()} ì›`;
            document.getElementById('resTotalCost').innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
            document.getElementById('pfRatioDisplay').innerText = pfRatio;
            document.getElementById('resLoanAmount').innerText = `${Math.round(loanAmount).toLocaleString()} ì›`;
            document.getElementById('resEquityAmount').innerText = `${Math.round(equityAmount).toLocaleString()} ì›`;
            document.getElementById('resInterest').innerText = `${Math.round(annualInterest).toLocaleString()} ì›`;
            document.getElementById('resPfPayback').innerText = `${pfPayback} ë…„`;
        }

        function toggleMultiSelect() {
            isMultiSelectMode = document.getElementById('multiSelectToggle').checked;
            if(isMultiSelectMode) {
                showToast("ê²°ê³¼ ëˆ„ì  ëª¨ë“œ ON");
            } else {
                showToast("ê²°ê³¼ ëˆ„ì  ëª¨ë“œ OFF");
                accumulatedPanelsCount = 0;
                panelGroup.clearLayers();
            }
        }

        function updateEstimatedTime() {
            const delay = parseInt(document.getElementById('scanDelay').value) || 1000;
            const totalZones = 20; 
            const totalSeconds = (delay / 1000) * totalZones;
            const min = Math.floor(totalSeconds / 60);
            const sec = Math.floor(totalSeconds % 60);
            document.getElementById('timerRemaining').innerText = `ì•½ ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')} ì†Œìš”`;
        }

        function applySliderCalibration(val, type) {
            const v = parseFloat(val);
            if(type === 'x') currentGeoState.x = v * 10; 
            if(type === 'y') currentGeoState.y = v * 10;
            if(type === 'rot') currentGeoState.rot = v;
            if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }

        function applyCalibration(dx, dy, drot=0) {
            currentGeoState.x += dx * 10; currentGeoState.y += dy * 10; currentGeoState.rot += drot;
            if(currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }

        function resetCalibration(redraw=true) {
            currentGeoState = { x:0, y:0, rot:0 };
            document.querySelectorAll('input[type=range]').forEach(el => el.value = 0);
            if(redraw && currentAnalysisFeature) drawPanels(currentAnalysisFeature.geometry);
        }

        function setRegion() {
            const val = document.getElementById('regionSelect').value;
            if(!val) return;
            const bounds = REGIONS[val];
            if(bounds) {
                if(bounds[0][0] === bounds[1][0]) {
                    map.setView(bounds[0], 13);
                    scanBuildings(bounds[0][0], bounds[0][1]);
                } else { map.fitBounds(bounds); }
                showToast("ì§€ì—­ ì´ë™");
            }
        }

        function switchTab(mode) {
            ['scan', 'analysis', 'legal'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`panel-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById(`panel-${mode}`).classList.remove('hidden');
        }

        function toggleTarget() {
            const els = document.getElementsByName('scanTarget');
            els.forEach(e => { if(e.checked) scanTarget = e.value; });
            showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === 'building' ? 'ê±´ë¬¼' : 'í† ì§€'}`);
        }
        
        function setMap(type) {
            if(type === 'base') { map.addLayer(layers.base); map.removeLayer(layers.sat); }
            else { map.addLayer(layers.sat); map.removeLayer(layers.base); }
            layers.hybrid.bringToFront();
        }

        function toggleLayer(type) {
            const center = map ? map.getCenter() : {lat:36.5, lng:127.5};
            if(type === 'existing') {
                if(document.getElementById('existingPlantToggle').checked) {
                    createMockMarkers(center, 'plant');
                    map.addLayer(existingGroup);
                } else {
                    existingGroup.clearLayers();
                    map.removeLayer(existingGroup);
                }
            } else if(type === 'substation') {
                 if(document.getElementById('substationToggle').checked) {
                    createMockMarkers(center, 'substation');
                    map.addLayer(substationGroup);
                 } else {
                    substationGroup.clearLayers();
                    map.removeLayer(substationGroup);
                 }
            } else if(type === 'cadastral') {
                 if(document.getElementById('cadastralToggle').checked) {
                     if(!cadastralLayer._map) map.addLayer(cadastralLayer);
                 } else {
                     if(cadastralLayer._map) map.removeLayer(cadastralLayer);
                 }
            }
        }
        
        function toggleAutoScan() {
            autoScanMode = document.getElementById('autoScanToggle').checked;
            if(autoScanMode) {
                showToast("ìë™ ìŠ¤ìº” í™œì„±í™”");
                onMapMoveEnd();
            } else {
                showToast("ìë™ ìŠ¤ìº” ë¹„í™œì„±í™”");
            }
        }
        
        function createMockMarkers(center, type) {
            const group = type === 'plant' ? existingGroup : substationGroup;
            group.clearLayers();
            const count = 3; 
            for(let i=0; i<count; i++) {
                const lat = center.lat + (Math.random() * 0.01 - 0.005);
                const lng = center.lng + (Math.random() * 0.01 - 0.005);
                const iconHtml = type === 'plant' 
                    ? `<div class="plant-marker w-6 h-6"><i class="ph ph-lightning text-white text-[10px]"></i></div>`
                    : `<div class="substation-marker w-8 h-8"><i class="ph ph-circuitry text-white"></i></div>`;
                
                const icon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [24, 24] });
                L.marker([lat, lng], { icon: icon }).bindPopup(type === 'plant' ? "ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘ (99kW)" : "ë³€ì „ì†Œ (ì—¬ìœ ìš©ëŸ‰: 10MW)").addTo(group);
            }
        }

        function startMission() {
            let seconds = 0;
            const timerEl = document.getElementById('timerRemaining');
            const interval = setInterval(() => {
                seconds++;
                timerEl.innerText = `ì§„í–‰ ì¤‘... ${seconds}s`;
                if(seconds > 10) clearInterval(interval);
            }, 1000);
            showToast("ìŠ¤ìº” ì‹œì‘");
        }

        function showToast(msg) {
            const el = document.getElementById('toastMsg');
            document.getElementById('toastText').innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function clearResults() {
            if(confirm("ê²°ê³¼ë¥¼ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                panelGroup.clearLayers();
                selectableGroup.clearLayers();
                accumulatedPanelsCount = 0;
                if(analysisMarker) map.removeLayer(analysisMarker);
                document.getElementById('resultCard').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
