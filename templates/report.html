<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Pathfinder Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
// -------- Re-run Deep analysis (best-effort) --------

async function rerunDeep(){
  const btn = document.getElementById("rerunDeepBtn");
  const msg = document.getElementById("rerunDeepMsg");
  const sk = document.getElementById("deepSkeleton");

  if(btn) btn.disabled = true;
  if(msg) msg.textContent = "ë°ì´í„° ëŒ€ê¸° ì¤‘â€¦ (ì •ë°€ ë¶„ì„ ì‹¤í–‰ ì¤‘)";
  if(sk){ sk.classList.remove("hidden"); }

  try{
    const r = await fetch("/api/analyze/deep", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        address: payload.address || "",
        mode: MODE,
        lat: payload.lat || null,
        lng: payload.lng || null,
        pnu: payload.pnu || null,
        panel_count: 0
      })
    });
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) throw new Error("deep failed");

    // 1) í•œì „ ìš©ëŸ‰ ì—…ë°ì´íŠ¸ (ì—†ìœ¼ë©´ ì ìƒ‰ ë¬¸êµ¬)
    const kepcoEl = document.getElementById("kepcoCapacityText");
    if(kepcoEl){
      const t = (j.kepco_capacity || "").trim();
      if(!t || t.includes("ì¡°íšŒ ë¶ˆê°€")){
        kepcoEl.textContent = "ì¡°íšŒ ë¶ˆê°€ (í•œì „ ë¬¸ì˜ ìš”ë§)";
        kepcoEl.className = "ml-1 text-red-300 font-extrabold";
      }else{
        kepcoEl.textContent = t;
        kepcoEl.className = "ml-1 text-amber-100";
      }
    }

    // 2) 8ëŒ€ ì²´í¬ì‚¬í•­ ì—…ë°ì´íŠ¸ (title ê¸°ì¤€ best-effort ë§¤ì¹­)
    const newChecks = Array.isArray(j.checks) ? j.checks : [];
    for(const c of newChecks){
      const title = (c.title || c.category || "").trim();
      if(!title) continue;
      const node = document.querySelector(`[data-check-title="${CSS.escape(title)}"] .check-result`);
      if(node) node.textContent = c.result || "í™•ì¸ í•„ìš”";
    }

    if(msg) msg.textContent = "ì •ë°€ ë¶„ì„ ì™„ë£Œ âœ… (ì¡°ë¡€/í•œì „/ë•…ê°’ ë°˜ì˜)";
  }catch(e){
    if(msg) msg.textContent = "ì •ë°€ ë¶„ì„ ì‹¤íŒ¨. ë‹¤ì‹œ ëˆŒëŸ¬ ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
  }finally{
    if(sk){ sk.classList.add("hidden"); }
    if(btn) btn.disabled = false;
  }
}
document.getElementById("rerunDeepBtn")?.addEventListener("click", rerunDeep);
addEventListener("click", rerunDeep);
</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-indigo-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.05),0_20px_60px_rgba(0,0,0,0.35)] overflow-hidden">
      <div class="p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div>
            <div class="flex items-center gap-2">
              <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-cyan-400/20 to-indigo-400/20 border border-white/10 flex items-center justify-center">
                <span class="text-lg font-black">SP</span>
              </div>
              <div>
                <div class="text-xl font-extrabold tracking-tight">ìƒì„¸ ë¦¬í¬íŠ¸</div>
                <div class="text-xs text-slate-300/80 mt-0.5">{{ date }}</div>
              </div>
            </div>
            <div class="mt-4">
              <div class="text-xs text-slate-300/80 font-bold">ì£¼ì†Œ</div>
              <div class="text-sm text-slate-100/90 break-words mt-1">{{ address }}</div>
            </div>
          </div>

          <div class="flex flex-col items-start md:items-end gap-3">
            <div class="flex items-center gap-2">
              <div class="px-3 py-1 rounded-full bg-emerald-400/10 border border-emerald-400/25 text-emerald-200 text-xs font-bold">
                êµ¬ë§¤ë§¤ë ¥ë„ <span class="ml-1 text-base text-emerald-100">{{ ai_score }}</span>
              </div>
              <div class="px-3 py-1 rounded-full bg-amber-400/10 border border-amber-400/25 text-amber-200 text-xs font-bold">
                í•œì „ ìš©ëŸ‰: <span id="kepcoCapacityText" class="ml-1 text-amber-100">{{ kepco_capacity }}</span>
              </div>
            </div>

            <div class="text-right">
              <div class="text-xs text-slate-300/80">ìš©ëŸ‰</div>
              <div class="text-2xl font-extrabold text-cyan-200 tracking-tight">{{ capacity }}</div>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-2 justify-end">
              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">í† ì§€</div>
                <button id="landOwnBtn" class="px-2 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-xs font-bold">ë³´ìœ </button>
                <button id="landBuyBtn" class="px-2 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-xs font-bold">êµ¬ë§¤</button>
              </div>

<!-- Roof rent (NEW) -->
<div id="roofRentBox" class="hidden flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
  <div class="text-[11px] text-slate-200/80 font-bold">ì§€ë¶•ì„ëŒ€(ì—°)</div>
  <input id="roofRentAnnual" type="number" step="10000" value="0" class="w-32 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
  <span class="text-[11px] text-slate-300/80">ì›/ë…„</span>
</div>

              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">ì‹œë‚˜ë¦¬ì˜¤</div>
                <select id="scenarioSel" class="bg-slate-900/60 border border-white/10 rounded-lg px-2 py-1 text-xs">
                  <option value="0.90">ë³´ìˆ˜</option>
                  <option value="1.00" selected>ê¸°ë³¸</option>
                  <option value="1.10">ë‚™ê´€</option>
                </select>
              </div>

              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">í• ì¸ìœ¨</div>
                <input id="discountRate" type="number" step="0.1" value="6.0" class="w-20 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
                <span class="text-[11px] text-slate-300/80">%</span>
                <button id="recalcRoi" class="px-3 py-1 rounded-lg bg-slate-100 text-slate-900 font-extrabold text-xs hover:bg-white">ì¬ê³„ì‚°</button>
              </div>
            </div>

<!-- Module / Inverter (NEW) -->
<div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
  <div class="text-[11px] text-slate-200/80 font-bold">ëª¨ë“ˆ</div>
  <select id="moduleSel" class="bg-slate-900/60 border border-white/10 rounded-lg px-2 py-1 text-xs min-w-[140px]">
  </select>
  <div class="text-[11px] text-slate-200/80 font-bold ml-2">ì¸ë²„í„°</div>
  <select id="inverterSel" class="bg-slate-900/60 border border-white/10 rounded-lg px-2 py-1 text-xs min-w-[140px]">
  </select>
</div>

          </div>
        </div>

        <!-- KPI cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-6">
          <div class="rounded-2xl bg-gradient-to-br from-slate-900/60 to-slate-900/20 border border-white/10 p-4">
            <div class="text-xs text-slate-300/80 font-bold">ì´ ì‚¬ì—…ë¹„</div>
            <div class="text-lg font-extrabold mt-1"><span id="kpiTotalCost">{{ finance.totalCostWon|default(0) | int | format_won }}</span></div>
            <div class="text-[11px] text-slate-400/80 mt-2">â€» ì¶”ì •ì¹˜</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-indigo-900/50 to-indigo-900/20 border border-white/10 p-4">
            <div class="text-xs text-indigo-200/90 font-bold">ì—° ìˆ˜ìµ(ê¸°ë³¸)</div>
            <div class="text-lg font-extrabold mt-1"><span id="kpiAnnualRevenue">{{ finance.annualRevenueWon|default(0) | int | format_won }}</span></div>
            <div class="text-[11px] text-indigo-200/70 mt-2">ì‹œë‚˜ë¦¬ì˜¤ë¡œ ë³€ë™</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-emerald-900/50 to-emerald-900/20 border border-white/10 p-4">
            <div class="text-xs text-emerald-200/90 font-bold">ì›” ìƒí™˜ì•¡(PF)</div>
            <div class="text-lg font-extrabold mt-1"><span id="kpiMonthlyDebt">{{ finance.monthlyDebtWon|default(0) | int | format_won }}</span></div>
            <div class="text-[11px] text-emerald-200/70 mt-2">ì´ì´ì <span id="kpiTotalInterest">{{ finance.totalInterestWon|default(0) | int | format_won }}</span></div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-amber-900/50 to-amber-900/20 border border-white/10 p-4">
            <div class="text-xs text-amber-200/90 font-bold">ìë³¸íšŒìˆ˜ê¸°ê°„</div>
            <div class="text-lg font-extrabold mt-1"><span id="kpiPayback">{{ finance.paybackYears if finance.paybackYears else "> 25" }}</span> ë…„</div>
            <div class="text-[11px] text-amber-200/70 mt-2">â€» ë³´ìˆ˜ì  ì¶”ì •</div>
          </div>
        </div>

        <!-- NPV/IRR -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">NPV / IRR (í† ì§€ë¹„ ì œì™¸)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">NPV</div>
                <div id="npvNo" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">IRR</div>
                <div id="irrNo" class="text-lg font-extrabold">-</div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">NPV / IRR (í† ì§€ë¹„ í¬í•¨)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">NPV</div>
                <div id="npvWith" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">IRR</div>
                <div id="irrWith" class="text-lg font-extrabold">-</div>
              </div>
            </div>
            <div id="landNote" class="text-[10px] text-amber-200/80 mt-2">â€» í† ì§€ê°€ê²© ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í¬í•¨/ì œì™¸ ì°¨ì´ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </div>

        
        <!-- DSCR -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR (PF ê¸°ê°„)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">ìµœì†Œ</div>
                <div id="dscrMin" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">í‰ê· </div>
                <div id="dscrAvg" class="text-lg font-extrabold">-</div>
              </div>
            </div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR ê¸°ì¤€</div>
            <div class="flex items-center gap-2">
              
              <div class="flex flex-wrap items-center gap-2 mb-3">
                <div class="flex items-center gap-2">
                  <span class="text-[11px] text-slate-300/70">ê¸ˆë¦¬</span>
                  <input id="pfInterestRate" type="number" step="0.1" value="5.5" class="w-20 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
                  <span class="text-[11px] text-slate-300/70">%</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-[11px] text-slate-300/70">ê¸°ê°„</span>
                  <input id="pfTenorYears" type="number" step="1" min="1" value="15" class="w-16 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
                  <span class="text-[11px] text-slate-300/70">ë…„</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-[11px] text-slate-300/70">LTV</span>
                  <input id="pfLtvPct" type="number" step="1" min="70" max="90" value="70" class="w-16 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
                  <span class="text-[11px] text-slate-300/70">%</span>
                </div>
                <div class="text-[11px] text-slate-300/70">
                  ì›” ìƒí™˜ì•¡: <span id="pfMonthlyPmt" class="font-extrabold text-slate-100">-</span>
                </div>
              </div>
<input id="dscrThreshold" type="number" step="0.05" value="1.20" class="w-24 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
              <span class="text-[11px] text-slate-300/70">ì´ìƒ</span>
              <button id="recalcPf" class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-xs font-extrabold hover:bg-white/15">íŒì •</button>
            </div>
            <div id="pfVerdict" class="mt-3 text-sm font-extrabold">-</div>
            <div class="text-[10px] text-slate-300/70 mt-1">â€» DSCRì€ (ìˆ˜ìµ-ìš´ì˜ë¹„-êµì²´CAPEX)/ì—°ë¶€ì±„ìƒí™˜ìœ¼ë¡œ ê³„ì‚°(ë³´ìˆ˜)</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR ì¶”ì´</div>
            <canvas id="dscrChart" height="110"></canvas>
          </div>
        </div>
<!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">25ë…„ í˜„ê¸ˆíë¦„(í† ì§€ë¹„ ì œì™¸)</div>
            <canvas id="cfChartNoLand" height="170"></canvas>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">25ë…„ í˜„ê¸ˆíë¦„(í† ì§€ë¹„ í¬í•¨)</div>
            <canvas id="cfChartWithLand" height="170"></canvas>
          </div>
        </div>

        <!-- Assumptions + Checklist -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">ì¶”ì • ê°€ì •(ë¬´ë°ì´í„° ë³´ì • í¬í•¨)</div>
            <div class="text-xs text-slate-200/80 space-y-2">
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">ì¼ì‚¬ëŸ‰</div>
                <div class="font-bold">{{ solar.sun_hours or "í™•ì¸ í•„ìš”" }} h/ì¼</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">ë°©ìœ„/ê²½ì‚¬</div>
                <div class="font-bold">{{ solar.azimuth_deg or "í™•ì¸ í•„ìš”" }}Â° / {{ solar.tilt_deg or "í™•ì¸ í•„ìš”" }}Â°</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">ë³´ì • ê³„ìˆ˜</div>
                <div class="font-bold">{{ solar.ori_factor or "í™•ì¸ í•„ìš”" }}</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">í† ì§€ê°€ê²©</div>
                <div class="font-bold">{{ land_price }}</div>
              </div>
              <div class="text-[10px] text-amber-200/80 font-bold mt-2">
                â€» ë°ì´í„° ì†ŒìŠ¤ í™•ì • ì „: ë³´ìˆ˜ì  ì¶”ì •ì´ë©° "í™•ì¸ í•„ìš”"ì…ë‹ˆë‹¤.
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­</div>
            <div class="space-y-2 text-xs">
              {% for c in ai_analysis.checks or [] %}
                <div class="p-3 rounded-xl border border-white/10 bg-black/10 flex items-center justify-between gap-3" data-check-title="{{ c.title or c.category }}">
                  <div>
                    <div class="font-extrabold text-slate-100">{{ c.title or c.category }}</div>
                    <div class="text-slate-300/70 mt-1 check-result">{{ c.result }}</div>
                  </div>
                  {% if c.link %}
                    <a class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-cyan-200 font-bold hover:bg-white/15"
                       href="{{ c.link }}" target="_blank">ë§í¬</a>
                  {% endif %}
                </div>
              {% endfor %}
              {% if (ai_analysis.checks or [])|length == 0 %}
                <div class="text-slate-400">AI ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Re-run Deep Analysis (NEW) -->

<!-- Deep skeleton (hidden by default) -->
<div id="deepSkeleton" class="hidden mt-4 space-y-2">
  <div class="h-4 rounded-lg bg-white/10 animate-pulse"></div>
  <div class="h-4 rounded-lg bg-white/10 animate-pulse w-5/6"></div>
  <div class="h-4 rounded-lg bg-white/10 animate-pulse w-2/3"></div>
</div>

<div class="mt-6 flex flex-wrap gap-2">
  <button id="rerunDeepBtn" class="px-4 py-2 rounded-xl bg-indigo-500/80 border border-indigo-300/20 font-extrabold hover:bg-indigo-500"
    type="button">ğŸ” AI ì •ë°€ ë¶„ì„ ë‹¤ì‹œ ì‹¤í–‰</button>
  <div id="rerunDeepMsg" class="text-xs text-slate-300/80 flex items-center"></div>
</div>

<!-- Actions -->
        <div class="flex flex-wrap gap-2 mt-6">
          <form method="POST" action="/api/report/pdf">
            <input type="hidden" name="payload" value="{{ payload_json|e }}">
            <button class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 font-extrabold hover:bg-white" type="submit">PDF ì¦‰ì‹œ ì¶œë ¥</button>
          </form>
          <a class="px-4 py-2 rounded-xl bg-white/10 border border-white/10 font-extrabold hover:bg-white/15" href="javascript:window.print()">ë¸Œë¼ìš°ì € ì¸ì‡„</a>
        </div>
      </div>
    </div>
  </div>

<script>
  const payload = {{ payload_json|safe }};
  const roi = (payload.finance && payload.finance.roi25y) ? payload.finance.roi25y : {};
  const cfNoRaw = Array.isArray(roi.cashflows_no_land) ? roi.cashflows_no_land : [];
  const cfWithRaw = Array.isArray(roi.cashflows_with_land) ? roi.cashflows_with_land : cfNoRaw;
  const landPrice = (roi && typeof roi.land_price_won === "number") ? roi.land_price_won : null;

  const dscrYearsRaw = Array.isArray(roi.dscr_years) ? roi.dscr_years : [];
  const dscrMinRaw = (typeof roi.dscr_min === "number") ? roi.dscr_min : null;
  const dscrAvgRaw = (typeof roi.dscr_avg === "number") ? roi.dscr_avg : null;

  // ---- PF ê¸ˆìœµ ë¡œì§ (Level Payment, ì‹œì¥ í‘œì¤€) ----
  const PF_DAYCOUNT_FACTOR = (365/360); // ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” 365/360 basis ë°˜ì˜(ê²€ì¦ ì¼€ì´ìŠ¤ ë§ì¶¤)

  function pmtLevelPayment(P, annualRatePct, years){
    const principal = Math.max(0, Number(P) || 0);
    const n = Math.max(1, Math.round((Number(years)||0) * 12));
    const r = Math.max(0, (Number(annualRatePct)||0)/100 * PF_DAYCOUNT_FACTOR / 12);
    if(principal <= 0) return 0;
    if(r <= 0) return principal / n;
    const pow = Math.pow(1+r, n);
    return principal * r * pow / (pow - 1);
  }

  function computeDscrFromCashflows(cadsYears, annualDebt){
    // cadsYears: [Y1..], annualDebt: yearly debt service (ì›)
    if(!Array.isArray(cadsYears) || !cadsYears.length || !(annualDebt>0)) return {years: [], min:null, avg:null};
    const years = cadsYears.map(v => (Number(v)||0) / annualDebt);
    const valid = years.filter(v => Number.isFinite(v) && v>0);
    if(!valid.length) return {years, min:null, avg:null};
    const min = Math.min(...valid);
    const avg = valid.reduce((a,b)=>a+b,0)/valid.length;
    return {years, min, avg};
  }


// -------- Module/Inverter catalog (fetched from backend) --------
let MODULES = [];
let INVERTERS = [];

// Convert backend rows -> option model
function _mapModuleRow(row){
  const id = String(row.no ?? row.id ?? "");
  const powerW = (row.power_w!=null) ? Number(row.power_w) : null;
  const effPct = (row.efficiency_pct!=null) ? Number(row.efficiency_pct) : null;
  const pricePerW = (row.price_won_per_w!=null) ? Number(row.price_won_per_w) : null;

  // revenue factor: baseline 20% íš¨ìœ¨ì„ 1.0ìœ¼ë¡œ (ë³´ìˆ˜)
  const effFactor = effPct ? Math.max(0.90, Math.min(1.08, effPct / 20.0)) : 1.0;

  return {
    id,
    name: `${row.brand||""} ${row.model||""}`.trim() + (powerW?` Â· ${powerW}W`:""),
    eff: effFactor,
    powerW,
    pricePerW,
  };
}
function _mapInverterRow(row){
  const id = String(row.no ?? row.id ?? "");
  const capKw = (row.capacity_kw!=null) ? Number(row.capacity_kw) : null;
  const priceWon = (row.price_won!=null) ? Number(row.price_won) : ((row.price_million_won!=null)? Number(row.price_million_won)*1_000_000 : null);

  // revenue factor: topology ê¸°ë°˜ ë³´ìˆ˜ ê°€ì¤‘(ê±°ì˜ 1.0)
  const topo = String(row.topology||"").toLowerCase();
  const effFactor = topo.includes("central") ? 1.005 : 1.0;

  return {
    id,
    name: `${row.brand||""} ${row.model||""}`.trim() + (capKw?` Â· ${capKw}kW`:""),
    eff: effFactor,
    capKw,
    priceWon,
  };
}

async function initModuleInverterUI(){
  const ms = document.getElementById("moduleSel");
  const is = document.getElementById("inverterSel");

  // skeleton
  if(ms) ms.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>`;
  if(is) is.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>`;

  try{
    const [mr, ir] = await Promise.all([
      fetch("/api/hardware/modules", {credentials:"include"}),
      fetch("/api/hardware/inverters", {credentials:"include"})
    ]);
    const mj = await mr.json().catch(()=>null);
    const ij = await ir.json().catch(()=>null);

    MODULES = (mj && mj.ok && Array.isArray(mj.items)) ? mj.items.map(_mapModuleRow) : [];
    INVERTERS = (ij && ij.ok && Array.isArray(ij.items)) ? ij.items.map(_mapInverterRow) : [];

    // fallback ìµœì†Œ 1ê°œ
    if(!MODULES.length) MODULES = [{id:"", name:"ëª¨ë“ˆ ëª©ë¡ ì—†ìŒ", eff:1.0}];
    if(!INVERTERS.length) INVERTERS = [{id:"", name:"ì¸ë²„í„° ëª©ë¡ ì—†ìŒ", eff:1.0}];

    if(ms) ms.innerHTML = MODULES.map(m=>`<option value="${m.id}">${m.name}</option>`).join("");
    if(is) is.innerHTML = INVERTERS.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");

    // default: ì²« í•­ëª©
    if(ms && !ms.value) ms.value = MODULES[0].id;
    if(is && !is.value) is.value = INVERTERS[0].id;

  }catch(e){
    if(ms) ms.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>`;
    if(is) is.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>`;
  }
}
function selectedEffFactor(){
  const ms = document.getElementById("moduleSel");
  const is = document.getElementById("inverterSel");
  const m = MODULES.find(x=>x.id === String(ms?.value||"")) || MODULES[0];
  const i = INVERTERS.find(x=>x.id === String(is?.value||"")) || INVERTERS[0];
  // revenue factor
  return (m.eff||1.0) * (i.eff||1.0);


function selectedCostDeltaYear1(){
  // ë³´ìˆ˜ì : ì„ íƒ ê¸°ìì¬ ë‹¨ê°€ê°€ 'ê¸°ë³¸ê°’(ì²« í•­ëª©)' ëŒ€ë¹„ ë¹„ì‹¸ë©´ 1ë…„ì°¨ CFì—ì„œ ì°¨ê°, ì‹¸ë©´ ê°€ì‚°.
  // ì •í™•í•œ BOS/ê³µì‚¬ë¹„ê¹Œì§€ëŠ” ë°˜ì˜í•˜ì§€ ì•Šê³ , 'ê¸°ìì¬ ë³€ê²½ì— ë”°ë¥¸ ì²´ê°'ì„ ë§Œë“¤ê¸° ìœ„í•œ UIìš© ë³´ì •ì´ë‹¤.
  try{
    const ms = document.getElementById("moduleSel");
    const is = document.getElementById("inverterSel");
    const m0 = MODULES[0];
    const i0 = INVERTERS[0];
    const m = MODULES.find(x=>x.id === String(ms?.value||"")) || m0;
    const inv = INVERTERS.find(x=>x.id === String(is?.value||"")) || i0;

    const baseCost = Number(payload?.finance?.totalCostWon || 0) || 0;
    if(baseCost <= 0) return 0;

    // ëª¨ë“ˆ ë¹„ìš© ë¹„ì¤‘ 45%, ì¸ë²„í„° 12% ê°€ì •(ë‚˜ë¨¸ì§€ëŠ” BOS/ê³µì‚¬/ì¸í—ˆê°€ ë“±)
    const modShare = 0.45, invShare = 0.12;

    const mFactor = (m?.pricePerW && m0?.pricePerW) ? (m.pricePerW / m0.pricePerW) : 1.0;
    const iFactor = (inv?.priceWon && i0?.priceWon) ? (inv.priceWon / i0.priceWon) : 1.0;

    const delta = baseCost * (modShare * (mFactor - 1.0) + invShare * (iFactor - 1.0));
    return Math.round(delta);
  }catch(e){ return 0; }
}

function updateKpiFromSeries(cfNo, cfWith){
  // KPI ì¹´ë“œ ì¼ë¶€ëŠ” ì„œë²„ ë Œë” ê°’ì´ë¼, í´ë¼ì´ì–¸íŠ¸ ì¬ê³„ì‚° ì‹œ í•¨ê»˜ ì—…ë°ì´íŠ¸
  try{
    const baseCost = Number(payload?.finance?.totalCostWon || 0) || 0;
    const delta = selectedCostDeltaYear1();
    const costEl = document.getElementById("kpiTotalCost");
    if(costEl) costEl.innerText = fmtWon(baseCost + Math.max(0, delta));

    const annualRevEl = document.getElementById("kpiAnnualRevenue");
    // ì—°ìˆ˜ìµì€ 1ë…„ì°¨ í˜„ê¸ˆíë¦„(í† ì§€ë¹„ ì œì™¸)ë¡œ ê·¼ì‚¬(ë³´ìˆ˜)
    if(annualRevEl && cfNo && cfNo.length) annualRevEl.innerText = fmtWon(cfNo[0]);

    const pbEl = document.getElementById("kpiPayback");
    if(pbEl && cfWith && cfWith.length){
      const cost = baseCost + Math.max(0, delta);
      const y1 = Math.max(1, cfWith[0] || 0);
      const pb = (cost / y1);
      pbEl.innerText = (isFinite(pb) ? (pb > 25 ? "> 25" : pb.toFixed(1)) : "í™•ì¸ í•„ìš”");
    }
  }catch(e){}
}
}

// -------- Mode: land vs roof (from server) --------
const MODE = (payload && payload.mode) ? payload.mode : "land"; // "land"|"roof"
if(MODE === "roof"){
  // Hide land buy/own controls in roof mode; show rent
  const landBtns = document.getElementById("landOwnBtn")?.parentElement;
  const landBox = landBtns ? landBtns.parentElement : null;
  if(landBox) landBox.classList.add("hidden");
  document.getElementById("roofRentBox")?.classList.remove("hidden");
  landMode = "own"; // not used
}
initModuleInverterUI();

  // State
  let landMode = (landPrice && landPrice > 0) ? "buy" : "own"; // buy | own
  let scenarioFactor = parseFloat(document.getElementById("scenarioSel")?.value || "1.0") || 1.0;

  // Buttons style
  function setBtnActive(id, active){
    const b = document.getElementById(id);
    if(!b) return;
    if(active){
      b.classList.add("bg-slate-100","text-slate-900");
      b.classList.remove("bg-white/10","text-slate-100");
    }else{
      b.classList.remove("bg-slate-100","text-slate-900");
      b.classList.add("bg-white/10","text-slate-100");
    }
  }

  function getSeries(){
  const effFactor = selectedEffFactor();
  // ê¸°ë³¸ í˜„ê¸ˆíë¦„ì€ payloadì—ì„œ ë°›ì€ ì—°ë„ë³„ í˜„ê¸ˆíë¦„(ì¶”ì •) ê¸°ë°˜.
  // ì‹œë‚˜ë¦¬ì˜¤/ëª¨ë“ˆ/ì¸ë²„í„° ì„ íƒì€ "ìˆ˜ìµ(=í˜„ê¸ˆíë¦„)ì— ë¹„ë¡€"ë¡œ ë³´ìˆ˜ì  ì ìš©.
  const deltaCapex = selectedCostDeltaYear1();
  const cfNo = cfNoRaw.map((v, idx) => {
    const vv = Math.round(v * scenarioFactor * effFactor);
    return (idx===0 ? Math.round(vv - deltaCapex) : vv);
  });

  const baseWith = (landMode === "own") ? cfNoRaw : cfWithRaw;
  let cfWith = baseWith.map((v, idx) => {
    const vv = Math.round(v * scenarioFactor * effFactor);
    return (idx===0 ? Math.round(vv - deltaCapex) : vv);
  });

  // ì§€ë¶•í˜•: ì„ëŒ€ë£ŒëŠ” With ìª½(ì‹¤ì œ ì‚¬ì—…ì„±)ì—ì„œ OPEXë¡œ ì°¨ê° ë°˜ì˜
  if(MODE === "roof"){
    const rent = parseFloat(document.getElementById("roofRentAnnual")?.value || "0") || 0;
    if(rent > 0){
      // cfWithRawëŠ” Y1..Y25 í˜•íƒœë¡œ ê°€ì •(ì›ë³¸ ì½”ë“œ ë¼ë²¨ì´ Y1ë¶€í„°)
      cfWith = cfWith.map((v, idx)=> Math.round(v - rent)); // ê°„ë‹¨íˆ ì—° ì„ëŒ€ë£Œ ì°¨ê°(ë³´ìˆ˜)
    }
  }

  return {cfNo, cfWith};
}

  const labels = (cfNoRaw.length ? cfNoRaw : cfWithRaw).map((_, i) => `Y${i+1}`);

  // Charts
  function makeBar(elId, data){
    const el = document.getElementById(elId);
    if(!el) return null;
    const ctx = el.getContext('2d');
    return new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'í˜„ê¸ˆíë¦„(ì›)', data }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } },
          y: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } }
        }
      }
    });
  }

  const init = getSeries();
  const chartNo = makeBar('cfChartNoLand', init.cfNo);
  const chartWith = makeBar('cfChartWithLand', init.cfWith);

  // DSCR chart (line)
  function makeLine(elId, data){
    const el = document.getElementById(elId);
    if(!el) return null;
    const ctx = el.getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'DSCR', data, tension: 0.25 }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } },
          y: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" }, suggestedMin: 0.8 }
        }
      }
    });
  }
  let dscrChart = makeLine("dscrChart", dscrYearsRaw);


  // NPV/IRR
  function fmtWon(n){
    try{ return Math.round(n).toLocaleString() + " ì›"; }catch(e){ return "í™•ì¸ í•„ìš”"; }
  }

  function npv(ratePct, cashflows){
    const r = (ratePct/100);
    let v = 0;
    for(let i=0;i<cashflows.length;i++){
      const t = i+1;
      v += cashflows[i] / Math.pow(1+r, t);
    }
    return v;
  }

  function irr(cashflows){
    let hasNeg=false, hasPos=false;
    for(const c of cashflows){ if(c<0) hasNeg=true; if(c>0) hasPos=true; }
    if(!(hasNeg && hasPos)) return null;

    let x = 0.08;
    for(let it=0; it<40; it++){
      let f=0, df=0;
      for(let i=0;i<cashflows.length;i++){
        const t=i+1;
        const denom = Math.pow(1+x, t);
        f += cashflows[i]/denom;
        df += -t * cashflows[i] / (denom*(1+x));
      }
      if(Math.abs(df) < 1e-9) break;
      const nx = x - f/df;
      if(!isFinite(nx)) break;
      if(Math.abs(nx-x) < 1e-6) { x=nx; return x*100; }
      x = Math.max(-0.9, Math.min(2.0, nx));
    }

    let lo=-0.5, hi=1.5;
    function f(rate){
      let s=0;
      for(let i=0;i<cashflows.length;i++){
        const t=i+1;
        s += cashflows[i]/Math.pow(1+rate, t);
      }
      return s;
    }
    let flo=f(lo), fhi=f(hi);
    if(!isFinite(flo) || !isFinite(fhi) || flo*fhi>0) return null;

    for(let it=0; it<80; it++){
      const mid = (lo+hi)/2;
      const fm = f(mid);
      if(Math.abs(fm) < 1e-6) return mid*100;
      if(flo*fm <= 0){ hi=mid; fhi=fm; }
      else { lo=mid; flo=fm; }
    }
    return ((lo+hi)/2)*100;
  }

  function recomputeRoiMetrics(){
    const rate = parseFloat(document.getElementById("discountRate")?.value || "6") || 6;
    const {cfNo, cfWith} = getSeries();
    updateKpiFromSeries(cfNo, cfWith);

    // Update charts
    if(chartNo){ chartNo.data.datasets[0].data = cfNo; chartNo.update(); }
    if(chartWith){ chartWith.data.datasets[0].data = cfWith; chartWith.update(); }

    // Update NPV/IRR
    const nNo = npv(rate, cfNo);
    const nWith = npv(rate, cfWith);
    const iNo = irr(cfNo);
    const iWith = irr(cfWith);

    const npvNoEl = document.getElementById("npvNo");
    const npvWithEl = document.getElementById("npvWith");
    const irrNoEl = document.getElementById("irrNo");
    const irrWithEl = document.getElementById("irrWith");

    if(npvNoEl) npvNoEl.innerText = fmtWon(nNo);
    if(npvWithEl) npvWithEl.innerText = fmtWon(nWith);
    if(irrNoEl) irrNoEl.innerText = (iNo===null ? "í™•ì¸ í•„ìš”" : (iNo.toFixed(2) + " %"));
    if(irrWithEl) irrWithEl.innerText = (iWith===null ? "í™•ì¸ í•„ìš”" : (iWith.toFixed(2) + " %"));

    const landNote = document.getElementById("landNote");
    if(landNote){
      if(landMode === "own"){
        landNote.innerText = "í† ì§€ ë³´ìœ  ê°€ì •: í† ì§€ê°€ê²©ì„ ì‚¬ì—…ë¹„ì— ë°˜ì˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }else{
        landNote.innerText = landPrice ? ("í† ì§€ êµ¬ë§¤ ê°€ì •: 1ë…„ì°¨ì— í† ì§€ê°€ê²©ì„ upfrontë¡œ ë°˜ì˜í•©ë‹ˆë‹¤.") : "í† ì§€ êµ¬ë§¤ ê°€ì •: í† ì§€ê°€ê²© ë°ì´í„°ê°€ ì—†ì–´ í¬í•¨/ì œì™¸ ì°¨ì´ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      }
    }

    setBtnActive("landOwnBtn", landMode==="own");
    setBtnActive("landBuyBtn", landMode==="buy");

    
    // DSCR (PF ê¸°ê°„) - í´ë¼ì´ì–¸íŠ¸ì—ì„œ PF íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê³„ì‚°
    const pfRate = parseFloat(document.getElementById("pfInterestRate")?.value || "5.5") || 5.5;
    const pfYears = parseInt(document.getElementById("pfTenorYears")?.value || "15", 10) || 15;
    let pfLtv = parseFloat(document.getElementById("pfLtvPct")?.value || "70") || 70;
    if(pfLtv < 70) pfLtv = 70;
    if(pfLtv > 90) pfLtv = 90;

    const baseCostNum = Number(payload?.finance?.totalCostWon || 0) || 0;
    const deltaCapex = selectedCostDeltaYear1();
    const totalCostNum = Math.max(0, baseCostNum + Math.max(0, deltaCapex));

    const principal = Math.round(totalCostNum * (pfLtv/100));
    const monthly = pmtLevelPayment(principal, pfRate, pfYears);
    const annualDebt = monthly * 12;

    const pfMonthlyEl = document.getElementById("pfMonthlyPmt");
    if(pfMonthlyEl) pfMonthlyEl.innerText = fmtWon(monthly);

    // KPI ì¹´ë“œ(ì›” ìƒí™˜ì•¡)ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    const kpiMonthly = document.getElementById("kpiMonthlyDebt");
    if(kpiMonthly) kpiMonthly.innerText = fmtWon(monthly);

    // CADSëŠ” "With" í˜„ê¸ˆíë¦„(ì—°ë„ë³„)ë¡œ ê·¼ì‚¬ (ë³´ìˆ˜ì )
    const dscr = computeDscrFromCashflows(cfWith.slice(0, pfYears), annualDebt);
    if(dscrChart){
      dscrChart.data.datasets[0].data = dscr.years;
      dscrChart.update();
    }

    const dscrMinEl = document.getElementById("dscrMin");
    const dscrAvgEl = document.getElementById("dscrAvg");
    if(dscrMinEl) dscrMinEl.innerText = (dscr.min===null ? "í™•ì¸ í•„ìš”" : dscr.min.toFixed(2));
    if(dscrAvgEl) dscrAvgEl.innerText = (dscr.avg===null ? "í™•ì¸ í•„ìš”" : dscr.avg.toFixed(2));

    // Verdict
// Verdict
    const thr = parseFloat(document.getElementById("dscrThreshold")?.value || "1.2") || 1.2;
    const verdictEl = document.getElementById("pfVerdict");
    if(verdictEl){
      if(dscrMinRaw===null){
        verdictEl.innerText = "í™•ì¸ í•„ìš”";
        verdictEl.className = "mt-3 text-sm font-extrabold";
      }else if(dscrMinRaw >= thr){
        verdictEl.innerText = `PF ê°€ëŠ¥(ë³´ìˆ˜) âœ…  ìµœì†Œ DSCR ${dscrMinRaw.toFixed(2)} â‰¥ ${thr.toFixed(2)}`;
        verdictEl.className = "mt-3 text-sm font-extrabold text-emerald-200";
      }else{
        verdictEl.innerText = `PF ë¦¬ìŠ¤í¬ âš ï¸  ìµœì†Œ DSCR ${dscrMinRaw.toFixed(2)} < ${thr.toFixed(2)}`;
        verdictEl.className = "mt-3 text-sm font-extrabold text-amber-200";
      }
    }
  }

    document.getElementById("recalcPf")?.addEventListener("click", (e)=>{ e.preventDefault(); recomputeRoiMetrics(); });
document.getElementById("recalcRoi")?.addEventListener("click", (e)=>{ e.preventDefault(); recomputeRoiMetrics(); });
  document.getElementById("scenarioSel")?.addEventListener("change", (e)=>{ scenarioFactor = parseFloat(e.target.value||"1")||1; recomputeRoiMetrics(); });

  document.getElementById("landOwnBtn")?.addEventListener("click", (e)=>{ e.preventDefault(); landMode="own"; recomputeRoiMetrics(); });
  document.getElementById("landBuyBtn")?.addEventListener("click", (e)=>{ e.preventDefault(); landMode="buy"; recomputeRoiMetrics(); });

  // init state
  setBtnActive("landOwnBtn", landMode==="own");
  setBtnActive("landBuyBtn", landMode==="buy");
document.getElementById("moduleSel")?.addEventListener("change", (e)=>{ recomputeRoiMetrics(); });
document.getElementById("inverterSel")?.addEventListener("change", (e)=>{ recomputeRoiMetrics(); });
document.getElementById("roofRentAnnual")?.addEventListener("input", (e)=>{ recomputeRoiMetrics(); });
  // Mission-5: í•œì „ ìš©ëŸ‰ í‘œì‹œ (ì—†ìœ¼ë©´ ë¹¨ê°„ìƒ‰ "ì¡°íšŒ ë¶ˆê°€")
  try{
    const el = document.getElementById("kepcoCapacityText");
    const v = String(payload?.ai_analysis?.kepco_capacity || payload?.kepco_capacity || "{{ kepco_capacity }}");
    if(el){
      if(!v || v.includes("í™•ì¸ í•„ìš”") || v.includes("ì¡°íšŒ ë¶ˆê°€")){
        el.textContent = "ì¡°íšŒ ë¶ˆê°€ (í•œì „ ë¬¸ì˜ ìš”ë§)";
        el.classList.add("text-red-400");
      }
    }
  }catch(e){}
  recomputeRoiMetrics();
</script>
</body>
</html>
