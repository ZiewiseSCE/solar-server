<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Pathfinder Report (fixed)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background: rgba(255,255,255,0.95); }
    .pill { border: 1px solid rgba(148,163,184,0.6); }
    .stickyTop { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(6px); }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="stickyTop bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold text-slate-800">Solar Pathfinder ë¦¬í¬íŠ¸</div>
        <div id="viewBadge" class="text-xs px-2 py-1 rounded-full pill text-slate-600 bg-white">LIST</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="backToListBtn" class="hidden px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                onclick="goList()">â† ë¦¬ìŠ¤íŠ¸</button>
        <button id="deepBtnTop" class="hidden px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-extrabold text-sm"
                onclick="rerunDeep()">ğŸ”„ AI ì •ë°€ ë¶„ì„</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- LIST -->
    <section id="listView" class="space-y-4">
      <div class="card rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm text-slate-600">
            ì „ìˆ˜ ìŠ¤ìº” ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (localStorage: <span class="font-mono">sp_scan_report_v1</span>)
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                    onclick="reloadData()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                    onclick="clearData()">ë¡œì»¬ ë°ì´í„° ì‚­ì œ</button>
          </div>
        </div>
      </div>

      <div class="card rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="text-left px-4 py-3">ìˆœìœ„</th>
                <th class="text-left px-4 py-3">ì£¼ì†Œ</th>
                <th class="text-left px-4 py-3">ì˜ˆìƒ ìˆ˜ìµë¥ (IRR)</th>
                <th class="text-left px-4 py-3">8ëŒ€ ì²´í¬ ìƒíƒœ</th>
                <th class="text-right px-4 py-3">ìƒì„¸</th>
              </tr>
            </thead>
            <tbody id="listBody" class="divide-y divide-slate-200 bg-white"></tbody>
          </table>
        </div>
        <div id="emptyHint" class="hidden p-6 text-center text-slate-500">
          í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ìŠ¤ìº” í›„ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤)
        </div>
      </div>
    </section>

    <!-- DETAIL -->
    <section id="detailView" class="hidden space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- 8 checks -->
        <div class="card rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-extrabold text-slate-800">âœ… 8ëŒ€ ì²´í¬ì‚¬í•­</div>
            <div id="checkSummaryPill" class="text-xs px-2 py-1 rounded-full pill bg-white text-slate-600">-</div>
          </div>
          <div id="checksGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
        </div>

        <!-- PF -->
        <div class="card rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-extrabold text-slate-800">ğŸ’° PF ìˆ˜ìµì„± ë¶„ì„</div>
            <div id="irrPill" class="text-xs px-2 py-1 rounded-full pill bg-white text-slate-600">IRR: -</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div class="text-xs text-slate-500">ìë³¸íšŒìˆ˜ê¸°ê°„</div>
              <div id="paybackText" class="text-lg font-extrabold text-slate-800">-</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div class="text-xs text-slate-500">ì˜ˆìƒ ì›”ìˆ˜ìµ</div>
              <div id="monthlyProfitText" class="text-lg font-extrabold text-slate-800">-</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div class="text-xs text-slate-500">ì˜ˆìƒ ì›”ìˆ˜ìµ IRR</div>
              <div id="monthlyIrrText" class="text-lg font-extrabold text-slate-800">-</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div class="text-xs text-slate-500">ì£¼ì†Œ</div>
              <div id="addrText" class="text-sm font-bold text-slate-800 break-all">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- expand sections -->
      <details class="card rounded-2xl shadow-sm border border-slate-200 p-4">
        <summary class="cursor-pointer font-bold text-slate-700">ë°œì „ëŸ‰ ìƒì„¸</summary>
        <pre id="solarDetail" class="mt-3 text-xs bg-slate-950 text-slate-100 rounded-xl p-3 overflow-auto">-</pre>
      </details>

      <details class="card rounded-2xl shadow-sm border border-slate-200 p-4">
        <summary class="cursor-pointer font-bold text-slate-700">ê¸°ìì¬ ìŠ¤í™</summary>
        <pre id="equipDetail" class="mt-3 text-xs bg-slate-950 text-slate-100 rounded-xl p-3 overflow-auto">-</pre>
      </details>

      <!-- Deep analysis area (kept compatible with previous report_latest.html) -->
      <div class="card rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="font-extrabold text-slate-800">ğŸ” AI ì •ë°€ ë¶„ì„</div>
          <button id="rerunDeepBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-extrabold text-sm"
                  onclick="rerunDeep()">ğŸ”„ AI ì •ë°€ ë¶„ì„</button>
        </div>
        <div id="rerunDeepMsg" class="text-sm text-slate-600 mt-2">ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ ì •ë°€ ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div id="deepSkeleton" class="hidden mt-3">
          <div class="animate-pulse space-y-2">
            <div class="h-3 bg-slate-200 rounded"></div>
            <div class="h-3 bg-slate-200 rounded w-5/6"></div>
            <div class="h-3 bg-slate-200 rounded w-4/6"></div>
          </div>
        </div>
        <pre id="deepResult" class="mt-3 text-xs bg-slate-950 text-slate-100 rounded-xl p-3 overflow-auto hidden"></pre>
      </div>
    </section>
  </main>

<script>
  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function safe(v, d="-"){ return (v===0 || v) ? v : d; }

  function loadScanData(){
    try{
      const raw = localStorage.getItem("sp_scan_report_v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }

  function saveScanData(arr){
    try{ localStorage.setItem("sp_scan_report_v1", JSON.stringify(arr||[])); }catch(e){}
  }

  function clearData(){
    if(confirm("ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?")){
      try{ localStorage.removeItem("sp_scan_report_v1"); }catch(e){}
      reloadData();
    }
  }

  function badgeStatusFromChecks(checks){
    // checks can be array of {label, status} or object
    let pass = 0, warn = 0, fail = 0, total = 0;
    const norm = [];
    if(Array.isArray(checks)){
      for(const c of checks){
        total++;
        const st = (c.status||c.state||c.result||"").toString().toLowerCase();
        if(st.includes("pass") || st.includes("ì í•©")) pass++;
        else if(st.includes("warn") || st.includes("ì£¼ì˜")) warn++;
        else if(st.includes("fail") || st.includes("ë¶ˆê°€") || st.includes("ìœ„í—˜")) fail++;
        norm.push({label: c.label||c.name||("ì²´í¬"+total), status: c.status||c.state||c.result||"UNKNOWN", detail: c.detail||c.reason||""});
      }
    } else if(checks && typeof checks === "object") {
      for(const [k,v] of Object.entries(checks)){
        total++;
        const st = (v.status||v.state||v.result||v||"").toString();
        const stL = st.toLowerCase();
        if(stL.includes("pass") || st.includes("ì í•©")) pass++;
        else if(stL.includes("warn") || st.includes("ì£¼ì˜")) warn++;
        else if(stL.includes("fail") || st.includes("ë¶ˆê°€") || st.includes("ìœ„í—˜")) fail++;
        norm.push({label:k, status: st, detail: v.detail||v.reason||""});
      }
    }
    let label = "í™•ì¸ í•„ìš”";
    let cls = "bg-slate-100 text-slate-700";
    if(fail>0){ label="ì£¼ì˜"; cls="bg-rose-100 text-rose-700"; }
    else if(warn>0){ label="ì£¼ì˜"; cls="bg-amber-100 text-amber-700"; }
    else if(pass>0){ label="ì í•©"; cls="bg-emerald-100 text-emerald-700"; }
    return {label, cls, counts:{pass,warn,fail,total}, items:norm};
  }

  function fmtIrr(row){
    const irr = row.irr ?? row.finance?.irr ?? row.finance?.irr_pct ?? row.finance?.irrPercent;
    if(irr === null || irr === undefined || irr === "") return "-";
    const n = Number(irr);
    if(!isFinite(n)) return String(irr);
    return (n>1 ? n.toFixed(1) : (n*100).toFixed(1)) + "%";
  }

  function renderList(){
    const arr = loadScanData();
    const tbody = document.getElementById("listBody");
    const empty = document.getElementById("emptyHint");
    tbody.innerHTML = "";

    if(!arr.length){
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    arr.forEach((row, i)=>{
      const checks = badgeStatusFromChecks(row.checks || row.ai?.checks || row.ai?.ai_checks);
      const pill = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs ${checks.cls}">${checks.label}</span>`;
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50";
      tr.innerHTML = `
        <td class="px-4 py-3 font-mono text-slate-600">${safe(row.rank, i+1)}</td>
        <td class="px-4 py-3 font-bold text-slate-800">${safe(row.address)}</td>
        <td class="px-4 py-3 text-slate-700">${fmtIrr(row)}</td>
        <td class="px-4 py-3">${pill}</td>
        <td class="px-4 py-3 text-right">
          <button class="px-3 py-1.5 rounded-lg bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold"
                  onclick="openDetail(${i})">ìƒì„¸ë³´ê¸°</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function goList(){
    history.replaceState({}, "", "report_fixed.html?view=list");
    document.getElementById("viewBadge").textContent = "LIST";
    document.getElementById("listView").classList.remove("hidden");
    document.getElementById("detailView").classList.add("hidden");
    document.getElementById("backToListBtn").classList.add("hidden");
    document.getElementById("deepBtnTop").classList.add("hidden");
    renderList();
  }

  function openDetail(idx){
    const arr = loadScanData();
    const row = arr[idx];
    if(!row) return;

    history.replaceState({}, "", `report_fixed.html?view=detail&idx=${idx}`);
    document.getElementById("viewBadge").textContent = "DETAIL";
    document.getElementById("listView").classList.add("hidden");
    document.getElementById("detailView").classList.remove("hidden");
    document.getElementById("backToListBtn").classList.remove("hidden");
    document.getElementById("deepBtnTop").classList.remove("hidden");

    // Header info
    document.getElementById("addrText").textContent = safe(row.address);

    // 8 checks
    const checks = badgeStatusFromChecks(row.checks || row.ai?.checks || row.ai?.ai_checks);
    const sum = `${checks.label} (PASS:${checks.counts.pass} / WARN:${checks.counts.warn} / FAIL:${checks.counts.fail})`;
    const pill = document.getElementById("checkSummaryPill");
    pill.textContent = sum;

    const grid = document.getElementById("checksGrid");
    grid.innerHTML = "";
    (checks.items.length ? checks.items : Array.from({length:8}).map((_,i)=>({label:`ì²´í¬ ${i+1}`, status:"í™•ì¸ í•„ìš”"}))).forEach(c=>{
      const st = (c.status||"").toString();
      const stL = st.toLowerCase();
      let cls = "bg-slate-50 border-slate-200 text-slate-700";
      if(stL.includes("pass") || st.includes("ì í•©")) cls="bg-emerald-50 border-emerald-200 text-emerald-700";
      else if(stL.includes("warn") || st.includes("ì£¼ì˜")) cls="bg-amber-50 border-amber-200 text-amber-700";
      else if(stL.includes("fail") || st.includes("ë¶ˆê°€") || st.includes("ìœ„í—˜")) cls="bg-rose-50 border-rose-200 text-rose-700";

      const div = document.createElement("div");
      div.className = `border rounded-xl p-3 ${cls}`;
      div.innerHTML = `
        <div class="text-xs font-bold">${safe(c.label)}</div>
        <div class="text-sm font-extrabold mt-1">${safe(st, "í™•ì¸ í•„ìš”")}</div>
        ${c.detail ? `<div class="text-xs mt-1 opacity-80">${c.detail}</div>` : ``}
      `;
      grid.appendChild(div);
    });

    // PF
    const f = row.finance || {};
    const payback = f.pf_payback_years || f.payback_years || f.payback || row.ai?.payback_years;
    const monthlyProfit = f.monthly_profit_won || f.monthly_profit || row.ai?.monthly_profit_won;
    const irr = row.irr ?? f.irr ?? f.irr_pct ?? f.irrPercent;

    document.getElementById("paybackText").textContent = (payback!==undefined && payback!==null) ? `${Number(payback).toFixed(1)}ë…„` : "-";
    document.getElementById("monthlyProfitText").textContent = (monthlyProfit!==undefined && monthlyProfit!==null) ? `${Number(monthlyProfit).toLocaleString()}ì›` : "-";
    document.getElementById("monthlyIrrText").textContent = fmtIrr(row);
    document.getElementById("irrPill").textContent = `IRR: ${fmtIrr(row)}`;

    // Details
    document.getElementById("solarDetail").textContent = JSON.stringify(row.ai?.solar_opt || row.ai?.solar || row.finance?.solar_opt || {}, null, 2);
    document.getElementById("equipDetail").textContent = JSON.stringify({
      module: row.ai?.module || row.meta?.module,
      inverter: row.ai?.inverter || row.meta?.inverter,
      capacity: row.meta?.capacity,
      kepco_capacity: row.meta?.kepco_capacity
    }, null, 2);

    // keep deep target address for API
    window.__deepTarget = { address: row.address, lat: row.meta?.lat, lng: row.meta?.lng, pnu: row.meta?.pnu };
  }

  function reloadData(){
    const view = (qs("view") || "list").toLowerCase();
    if(view === "detail"){
      const idx = parseInt(qs("idx") || "0", 10);
      openDetail(isFinite(idx) ? idx : 0);
    } else {
      goList();
    }
  }

  // -------- Deep analysis (best-effort) --------
  async function rerunDeep(){
    const btn = document.getElementById("rerunDeepBtn");
    const btnTop = document.getElementById("deepBtnTop");
    const msg = document.getElementById("rerunDeepMsg");
    const sk = document.getElementById("deepSkeleton");
    const out = document.getElementById("deepResult");

    if(btn) btn.disabled = true;
    if(btnTop) btnTop.disabled = true;
    if(msg) msg.textContent = "ë°ì´í„° ëŒ€ê¸° ì¤‘â€¦ (ì •ë°€ ë¶„ì„ ì‹¤í–‰ ì¤‘)";
    if(sk) sk.classList.remove("hidden");
    if(out) out.classList.add("hidden");

    try{
      const payload = window.__deepTarget || {};
      const r = await fetch("/api/analyze/deep", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          address: payload.address || "",
          lat: payload.lat ?? null,
          lng: payload.lng ?? null,
          pnu: payload.pnu || ""
        })
      });
      const j = await r.json().catch(()=>null);
      if(!r.ok) throw new Error((j && (j.message||j.error)) || ("HTTP "+r.status));
      if(msg) msg.textContent = "ì •ë°€ ë¶„ì„ ì™„ë£Œ";
      if(out){
        out.textContent = JSON.stringify(j, null, 2);
        out.classList.remove("hidden");
      }
    }catch(e){
      if(msg) msg.textContent = "ì •ë°€ ë¶„ì„ ì‹¤íŒ¨: " + (e && e.message ? e.message : e);
    }finally{
      if(sk) sk.classList.add("hidden");
      if(btn) btn.disabled = false;
      if(btnTop) btnTop.disabled = false;
    }
  }

  // expose
  window.openDetail = openDetail;
  window.goList = goList;
  window.reloadData = reloadData;
  window.clearData = clearData;
  window.rerunDeep = rerunDeep;

  reloadData();
</script>


<script>
/* ============================================================
   âœ… Report Logic Restore Pack
   - ë³µêµ¬ë¨: view=list ë¡œì»¬ìŠ¤í† ë¦¬ì§€(sp_scan_report_v1) ë Œë”ë§
   - ë³µêµ¬ë¨: ìƒì„¸ë³´ê¸° â†’ detail ì „í™˜ + idx ê¸°ë°˜ ë Œë”ë§
   ============================================================ */
(function(){
  // report_fixed.htmlì—ì„œ ê³ ì •ëœ ê²½ë¡œë¥¼ report_fixed.htmlë¡œ ë³´ì •
  const selfName = "report_fixed.html";
  function fixUrl(u){
    return (u||"").replaceAll("report_fixed.html", selfName);
  }
  // history navigation functionsê°€ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´, replaceState URLë§Œ êµì²´
  const _replace = history.replaceState.bind(history);
  history.replaceState = function(st, title, url){
    try{ url = fixUrl(url); }catch(e){}
    return _replace(st, title, url);
  };

  // ë°ì´í„°ê°€ ì—†ì„ ë•Œ UX ê°œì„ (ë¹ˆ í™”ë©´ ë°©ì§€)
  function hasData(){
    try{
      const raw = localStorage.getItem("sp_scan_report_v1");
      const arr = JSON.parse(raw||"[]");
      return Array.isArray(arr) && arr.length>0;
    }catch(e){ return false; }
  }

  // ìµœì´ˆ ì§„ì… ì‹œ view íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ listë¡œ ìœ ë„(ìš”êµ¬ì‚¬í•­: list view ì¤‘ì‹¬)
  const qs = new URLSearchParams(location.search);
  if(!qs.get("view")){
    const target = hasData() ? `${selfName}?view=list` : `${selfName}?view=list`;
    try{ _replace({}, "", target); }catch(e){}
  }
})();
</script>

</body>
</html>
