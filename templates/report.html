<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>태양광 분석 리포트</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @media print { .no-print { display:none !important; } body { background:white; } }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <div class="max-w-5xl mx-auto p-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold">태양광 발전사업 분석 리포트</h1>
        <div class="text-sm text-slate-600 mt-1">
          <span class="font-semibold">주소:</span> <span id="addrText">{{ address or "" }}</span>
          <span class="mx-2">·</span>
          <span class="font-semibold">작성일:</span> {{ date or "" }}
        </div>
      </div>
      <div class="no-print flex gap-2">
        <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm font-bold" onclick="window.print()">인쇄</button>
        <button class="px-3 py-2 rounded bg-blue-600 text-white text-sm font-bold" onclick="downloadPdf()">PDF 다운로드</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div class="bg-white rounded-lg p-4 border">
        <div class="text-xs text-slate-500 font-bold">설비용량(kW)</div>
        <div class="text-2xl font-extrabold mt-1" id="capText">-</div>
      </div>
      <div class="bg-white rounded-lg p-4 border">
        <div class="text-xs text-slate-500 font-bold">연 추정수익(원)</div>
        <div class="text-2xl font-extrabold mt-1" id="annualText">-</div>
      </div>
      <div class="bg-white rounded-lg p-4 border">
        <div class="text-xs text-slate-500 font-bold">구매매력도(0-100)</div>
        <div class="text-2xl font-extrabold mt-1" id="scoreText">-</div>
        <div class="text-xs text-slate-500 mt-1">보수적 스코어링(자료 미확인 시 감점)</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
      <div class="bg-white rounded-lg p-4 border">
        <div class="font-bold mb-2">25년 현금흐름(요약)</div>
        <canvas id="cashflowChart" height="140"></canvas>
      </div>
      <div class="bg-white rounded-lg p-4 border">
        <div class="font-bold mb-2">비용/수익 구성(요약)</div>
        <canvas id="mixChart" height="140"></canvas>
      </div>
    </div>

    <div class="bg-white rounded-lg p-4 border mt-6">
      <div class="font-bold mb-2">8대 중대 체크사항</div>
      <div id="checksList" class="space-y-2 text-sm"></div>
      <div class="text-xs text-slate-500 mt-3">
        * 자동 표기 항목은 참고용이며, 최종 인허가/규제 판단은 해당 기관 조회 및 서류 확인이 필요합니다.
      </div>
    </div>

    <div class="bg-white rounded-lg p-4 border mt-6">
      <div class="font-bold mb-2">ROI(토지값 포함/제외)</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
        <div class="p-3 rounded border bg-slate-50">
          <div class="text-xs text-slate-500 font-bold">토지값 제외</div>
          <div class="text-xl font-extrabold mt-1" id="roiExText">-</div>
        </div>
        <div class="p-3 rounded border bg-slate-50">
          <div class="text-xs text-slate-500 font-bold">토지값 포함</div>
          <div class="text-xl font-extrabold mt-1" id="roiInText">-</div>
          <div class="text-xs text-slate-500 mt-1" id="landNote">토지 시세는 별도 확인 필요</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const FINANCE = JSON.parse({{ finance_json|tojson|safe }});
  const AI = JSON.parse({{ ai_json|tojson|safe }});

  function n(v){ if(v===undefined||v===null||v==="") return null; const x=Number(v); return Number.isFinite(x)?x:null; }
  function money(v){
    const x=n(v); if(x===null) return "-";
    return x.toLocaleString('ko-KR');
  }

  // header stats
  const cap = n(FINANCE.capacity ?? FINANCE.acCapacity);
  document.getElementById('capText').innerText = cap!==null ? cap.toLocaleString('ko-KR') : '-';
  document.getElementById('annualText').innerText = money(FINANCE.annualProfit ?? FINANCE.annual_profit ?? FINANCE.annualRevenue);
  document.getElementById('scoreText').innerText = (AI.score!==undefined && AI.score!==null) ? AI.score : '-';

  // checks
  const checks = AI.checks || [];
  const box = document.getElementById('checksList');
  if (checks.length){
    checks.forEach(c=>{
      const div=document.createElement('div');
      div.className="p-3 rounded border flex items-start justify-between gap-3";
      div.innerHTML = `
        <div>
          <div class="font-bold">${c.name || ''} <span class="ml-2 text-xs px-2 py-0.5 rounded bg-slate-200">${c.result||''}</span></div>
          <div class="text-xs text-slate-600 mt-1">${c.note || ''}</div>
        </div>
        <a class="text-xs text-blue-600 font-bold whitespace-nowrap" href="${c.url||'#'}" target="_blank">근거 링크</a>
      `;
      box.appendChild(div);
    });
  } else {
    box.innerHTML = '<div class="text-slate-500">표기할 체크사항 데이터가 없습니다.</div>';
  }

  // cashflow chart (best-effort)
  const years = [];
  const vals = [];
  for (let y=1;y<=25;y++){
    years.push(String(y));
    // if yearly_profit array exists use it, else flat annualProfit
    const arr = FINANCE.yearlyProfit || FINANCE.cashflow || null;
    if (Array.isArray(arr) && arr.length>=y) vals.push(Number(arr[y-1]||0));
    else vals.push(Number(FINANCE.annualProfit || FINANCE.annual_profit || 0));
  }
  new Chart(document.getElementById('cashflowChart'), {
    type:'bar',
    data:{ labels:years, datasets:[{ label:'연 현금흐름(원)', data:vals }]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{maxTicksLimit:10}}} }
  });

  // mix chart
  const capex = n(FINANCE.capex) ?? n(FINANCE.totalCost) ?? 0;
  const opex = n(FINANCE.opex) ?? n(FINANCE.annualOpex) ?? 0;
  const rev = n(FINANCE.annualProfit) ?? 0;
  new Chart(document.getElementById('mixChart'), {
    type:'doughnut',
    data:{ labels:['CAPEX(설치비)', 'OPEX(연 운영비)', '연 수익'], datasets:[{ data:[capex, opex, rev] }]},
    options:{ responsive:true }
  });

  // ROI include/exclude land value (if provided)
  const roiEx = n(FINANCE.roi25 ?? FINANCE.roi_25);
  document.getElementById('roiExText').innerText = roiEx!==null ? `${roiEx.toFixed(1)}%` : '-';

  const landPrice = n(FINANCE.landPrice); // optional, if frontend supplies
  if (landPrice!==null && roiEx!==null) {
    // naive adjust: add landPrice to capex
    const base = capex>0 ? capex : 1;
    const roiIn = (rev*25 - (base + landPrice)) / (base + landPrice) * 100;
    document.getElementById('roiInText').innerText = `${roiIn.toFixed(1)}%`;
    document.getElementById('landNote').innerText = `토지값: ${money(landPrice)}원 (입력값 기준)`;
  } else {
    document.getElementById('roiInText').innerText = '-';
  }

  async function downloadPdf(){
    const payload = {
      address: document.getElementById('addrText').innerText || '',
      date: "{{ date or '' }}",
      finance: FINANCE,
      ai_analysis: AI
    };
    const res = await fetch('/api/report/pdf', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) { alert('PDF 생성 실패'); return; }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='report.pdf'; a.click();
    URL.revokeObjectURL(url);
  }
  window.downloadPdf = downloadPdf;
</script>
</body>
</html>
